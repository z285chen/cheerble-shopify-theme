{%- if section.blocks.size > 0 -%}
  {%- render 'section-spacing-collapsing' -%}

  <style>
    #shopify-section-{{ section.id }} {
      --impact-text-font-size: calc(min(20vw, 65px) * {{ section.settings.impact_text_size_ratio | default: 1.0 }});
      --impact-text-auto-columns: {% if section.blocks.size == 1 %}minmax(0, 1fr){% else %}{% if section.settings.text_divider != 'none' %}48vw auto{% else %}64vw{% endif %}{% endif %};
      --cust-impact-text-bg-color: {{section.settings.impact_color_bg}};
      --cust-impact-text-card-color: {{section.settings.impact_color_card}};
      {% if section.settings.background_image_mobile != blank %}
      --cust-impact-text-bg: url({{section.settings.background_image_mobile | image_url: width: section.settings.background_image_mobile.width }});
      --cust-impact-bg-aspect-ratio: {{ 1 | divided_by: section.settings.background_image_mobile.aspect_ratio | times: 100}}%;
      {% endif %}
    }

    @media screen and (max-width: 699px) {
      {%- if section.settings.stack_mobile and section.settings.mobile_items_per_row == '2' -%}
        #shopify-section-{{ section.id }} .impact-text {
          display: grid !important;
          grid-template-columns: repeat(2, 1fr) !important;
          gap: 12px 8px !important; /* 缩小间距，给卡片留出更多空间 */
          padding: 0 10px; /* 侧边留一点距离 */
        }
        
        /* 1. 核心：大幅缩小 2x2 模式下的数字字号 */
        #shopify-section-{{ section.id }} {
          --impact-text-font-size: calc(min(10vw, 28px) * {{ section.settings.impact_text_size_ratio | default: 1.0 }}) !important;
        }

        /* 2. 压缩卡片内边距，防止内容被挤出 */
        #shopify-section-{{ section.id }} .snap-center {
          padding: 15px 10px !important; /* 减小内部上下左右边距 */
          height: 100%;
          display: flex;
          flex-direction: column;
          justify-content: center;
          background-color: var(--cust-impact-text-card-color); /* 确保背景色应用 */
          border-radius: 8px; /* 轻微圆角 */
        }

        /* 3. 缩小下方描述文字的字号 */
        #shopify-section-{{ section.id }} .impact-text__content .h4 {
          font-size: 14px !important; /* 小标题字号 */
          line-height: 1.2;
          margin-bottom: 4px;
          padding-left: 10px !important;
          padding-right: 10px !important;
        }
        #shopify-section-{{ section.id }} .impact-text__content .content {
          font-size: 12px !important; /* 描述文字字号 */
          line-height: 1.3;
        }

        /* 强制隐藏多余的分隔形状 */
        #shopify-section-{{ section.id }} .impact-text > span[class^="shape-"] {
          display: none !important;
        }
      {%- endif -%}
    }

    @media screen and (min-width: 700px) {
      #shopify-section-{{ section.id }} {
        --impact-text-font-size: calc(min(15vw, var(--container-max-width) * 0.15) / {{ section.blocks.size }} * {{ section.settings.impact_text_size_ratio | default: 1.0 }});
        --impact-text-auto-columns: {% if section.settings.text_divider != 'none' %}minmax(0, 1fr) auto{% else %}minmax(0, 1fr){% endif %};
        {% if section.settings.background_image_desktop != blank %}
        --cust-impact-text-bg: url({{section.settings.background_image_desktop | image_url: width: section.settings.background_image_desktop.width }});
        --cust-impact-bg-aspect-ratio: {{ 1 | divided_by: section.settings.background_image_desktop.aspect_ratio | times: 100}}%;
        {% endif %}
      }
    }
  </style>

  {% assign base_class = "" %}
  {% if section.settings.background_image_desktop %}
    {% assign base_class = "has-background-image" %}
  {% endif %}
  <div {% render 'section-properties' , class: base_class %}>
    <div {% unless section.settings.stack_mobile %}class="scroll-area bleed {% if section.blocks.size < 4 %}sm:unbleed{% else %}md:unbleed{% endif %}"{% endunless %}>
      {%- if section.settings.title != blank -%}
        <div class="cust-impact-text-dec__title-box">
            <h2 class="cust-impact-text__title">{{ section.settings.title | escape }}</h2>
            {% if section.settings.description %}
              <div class="cust-impact-text__desc">{{ section.settings.description | escape }}</div>
            {% endif %}
        </div>
      {%- endif -%}
      <div class="impact-text impact-text--{{ section.settings.text_alignment }} {% unless section.settings.stack_mobile %}impact-text--scroll{% endunless %}">
          {%- for block in section.blocks -%}
            <div class="snap-center" {{ block.shopify_attributes }}>
              {%- if block.settings.title != blank -%}
                <div class="impact-text__text heading break-all h2">
                  <impact-text {% if block.settings.animate_impact_text %}count-up="{{ block.settings.animate_impact_text_duration }}"{% endif %} reveal-js>
                    {%- render 'styled-text', content: block.settings.title, text_color: section.settings.heading_text_color, gradient: section.settings.heading_gradient, style: section.settings.impact_text_style -%}
                  </impact-text>
                </div>
              {%- endif -%}

              {%- if block.settings.subheading != blank or block.settings.content != blank or block.settings.button_text != blank -%}
                <div class="impact-text__content">
                  <div class="prose">
                    {%- if block.settings.subheading != blank -%}
                      <h3 class="h4">{{ block.settings.subheading | escape }}</h3>
                    {%- endif -%}
                    <div class="content">{{- block.settings.content -}}</div>
                    {%- if block.settings.button_text != blank -%}
                      {%- render 'button', content: block.settings.button_text, href: block.settings.button_url, size: 'xl', background: section.settings.button_background, text_color: section.settings.button_text_color -%}
                    {%- endif -%}
                  </div>
                </div>
              {%- endif -%}
            </div>

            {%- unless forloop.last or section.settings.text_divider == 'none' -%}
              {%- case section.settings.text_divider -%}
                {%- when 'square' -%}<span class="shape-square shape--lg place-self-center"></span>
                {%- when 'circle' -%}<span class="shape-circle shape--lg place-self-center"></span>
                {%- when 'diamond' -%}<span class="shape-diamond shape--lg place-self-center"></span>
                {%- when 'line' -%}<span class="shape-line {% if section.settings.stack_mobile %}hidden sm:block{% endif %}"></span>
              {%- endcase -%}
            {%- endunless -%}
          {%- endfor -%}
      </div>
    </div>
  </div>
{%- endif -%}

{% schema %}
{
  "name": "Cust Impact text",
  "class": "shopify-section--impact-text cust-impact-text",
  "tag": "section",
  "disabled_on": {
    "templates": ["password"],
    "groups": ["header", "custom.overlay"]
  },
  "max_blocks": 4,
  "blocks": [
    {
      "type": "item",
      "name": "Item",
      "settings": [
        { "type": "text", "id": "title", "label": "Impact text", "default": "100%" },
        { "type": "text", "id": "subheading", "label": "Subheading", "default": "Benefit text" },
        { "type": "richtext", "id": "content", "label": "Content" },
        { "type": "text", "id": "button_text", "label": "Button text" },
        { "type": "url", "id": "button_url", "label": "Button link" },
        { "type": "checkbox", "id": "animate_impact_text", "label": "Show count up animation", "default": false },
        { "type": "range", "id": "animate_impact_text_duration", "label": "Count up duration", "min": 0.5, "max": 5, "step": 0.1, "unit": "s", "default": 2 }
      ]
    }
  ],
  "settings": [
    { "type": "checkbox", "id": "stack_mobile", "label": "Stack on mobile", "default": true },
    {
      "type": "select",
      "id": "mobile_items_per_row",
      "label": "Mobile items per row",
      "info": "Only works when 'Stack on mobile' is checked.",
      "options": [
        { "value": "1", "label": "1 Column" },
        { "value": "2", "label": "2 Columns (Grid)" }
      ],
      "default": "1"
    },
    { "type": "text", "id": "title", "label": "Heading" },
    { "type": "textarea", "id": "description", "label": "description" },
    { "type": "range", "id": "impact_text_size_ratio", "label": "Impact text size ratio", "min": 0.5, "max": 1.5, "step": 0.1, "default": 1.0 },
    { "type": "color", "id": "impact_color_bg", "label": "Bg Color", "default": "#fbfbfb" },
    { "type": "color", "id": "impact_color_card", "label": "Card Color", "default": "#ffffff" },
    { "type": "image_picker", "id": "background_image_desktop", "label": "Background Image(Desktop)" },
    { "type": "image_picker", "id": "background_image_mobile", "label": "Background Image(Mobile)" },
    { "type": "select", "id": "text_alignment", "label": "Text alignment", "options": [{ "value": "start", "label": "Left" }, { "value": "center", "label": "Center" }, { "value": "end", "label": "Right" }], "default": "center" },
    { "type": "select", "id": "impact_text_style", "label": "Impact text style", "options": [{ "value": "outline", "label": "Outline" }, { "value": "fill", "label": "Fill" }], "default": "fill" },
    { "type": "select", "id": "text_divider", "label": "Multiple texts divider", "options": [{ "value": "none", "label": "None" }, { "value": "square", "label": "Square" }, { "value": "circle", "label": "Circle" }, { "value": "diamond", "label": "Diamond" }, { "value": "line", "label": "Line" }], "default": "none" },
    { "type": "header", "content": "Colors" },
    { "type": "color", "id": "heading_text_color", "label": "Impact text" },
    { "type": "color_background", "id": "heading_gradient", "label": "Impact text gradient" },
    { "type": "color", "id": "button_background", "label": "Button background" },
    { "type": "color", "id": "button_text_color", "label": "Button text" }
  ],
  "presets": [
    { "name": "Cust Impact text", "blocks": [{ "type": "item" }] }
  ]
}
{% endschema %}
{% comment %}
Auto-generated by Shogun-AB.
This file can be re-written at any time.
{% endcomment %}


{%- comment -%}
  =====================================================
  CONTENT TYPE DETECTION
  Assigns the appropriate content object based on template type
  =====================================================
{%- endcomment -%}
{% if article %}
  {% assign content = article %}
{% elsif blog %}
  {% assign content = blog %}
{% elsif page %}
  {% assign content = page %}
{% elsif product %}
  {% assign content = product %}
{% elsif collection %}
  {% assign content = collection %}
{% elsif metaobject %}
  {% assign content = metaobject.system %}
{% endif %}

{%- comment -%}
  =====================================================
  CONSENT TRACKING & OPTIMIZER SCRIPT
  =====================================================
{%- endcomment -%}
<script src="/cdn/shopifycloud/consent-tracking-api/v0.1/consent-tracking-api.js"></script>

<script type="text/javascript">
  {% raw %}
    var Y=Object.defineProperty;var X=(m,g,p)=>g in m?Y(m,g,{enumerable:!0,configurable:!0,writable:!0,value:p}):m[g]=p;var n=(m,g,p)=>X(m,typeof g!="symbol"?g+"":g,p);(function(){"use strict";var m=" daum[ /]| deusu/| yadirectfetcher|(?:^|[^g])news(?!sapphire)|(?<! (?:channel/|google/))google(?!(app|/google| pixel))|(?<! cu)bots?(?:\\b|_)|(?<!(?:lib))http|(?<![hg]m)score|(?<!cam)scan|@[a-z][\\w-]+\\.|\\(\\)|\\.com\\b|\\btime/|\\||^<|^[\\w \\.\\-\\(?:\\):%]+(?:/v?\\d+(?:\\.\\d+)?(?:\\.\\d{1,10})*?)?(?:,|$)|^[^ ]{50,}$|^\\d+\\b|^\\w*search\\b|^\\w+/[\\w\\(\\)]*$|^active|^ad muncher|^amaya|^avsdevicesdk/|^biglotron|^bot|^bw/|^clamav[ /]|^client/|^cobweb/|^custom|^ddg[_-]android|^discourse|^dispatch/\\d|^downcast/|^duckduckgo|^email|^facebook|^getright/|^gozilla/|^hobbit|^hotzonu|^hwcdn/|^igetter/|^jeode/|^jetty/|^jigsaw|^microsoft bits|^movabletype|^mozilla/\\d\\.\\d\\s[\\w\\.-]+$|^mozilla/\\d\\.\\d\\s\\(compatible;?(?:\\s\\w+\\/\\d+\\.\\d+)?\\)$|^navermailapp|^netsurf|^offline|^openai/|^owler|^php|^postman|^python|^rank|^read|^reed|^rest|^rss|^snapchat|^space bison|^svn|^swcd |^taringa|^thumbor/|^track|^w3c|^webbandit/|^webcopier|^wget|^whatsapp|^wordpress|^xenu link sleuth|^yahoo|^yandex|^zdm/\\d|^zoom marketplace/|^{{.*}}$|analyzer|archive|ask jeeves/teoma|audit|bit\\.ly/|bluecoat drtr|browsex|burpcollaborator|capture|catch|check\\b|checker|chrome-lighthouse|chromeframe|classifier|cloudflare|convertify|crawl|cypress/|dareboost|datanyze|dejaclick|detect|dmbrowser|download|evc-batch/|exaleadcloudview|feed|firephp|functionize|gomezagent|grab|headless|httrack|hubspot marketing grader|hydra|ibisbrowser|infrawatch|insight|inspect|iplabel|ips-agent|java(?!;)|library|linkcheck|mail\\.ru/|manager|measure|neustar wpm|node|nutch|offbyone|onetrust|optimize|pageburst|pagespeed|parser|perl|phantomjs|pingdom|powermarks|preview|proxy|ptst[ /]\\d|retriever|rexx;|rigor|rss\\b|scrape|server|sogou|sparkler/|speedcurve|spider|splash|statuscake|supercleaner|synapse|synthetic|tools|torrent|transcoder|url|validator|virtuoso|wappalyzer|webglance|webkit2png|whatcms/|xtate/",g=/bot|crawl|http|lighthouse|scan|search|spider/i,p;function M(){if(p instanceof RegExp)return p;try{p=new RegExp(m,"i")}catch{p=g}return p}function O(c){return!!c&&M().test(c)}/*! js-cookie v3.0.5 | MIT */function _(c){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var i in t)c[i]=t[i]}return c}var U={read:function(c){return c[0]==='"'&&(c=c.slice(1,-1)),c.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(c){return encodeURIComponent(c).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}};function S(c,e){function t(r,s,a){if(!(typeof document>"u")){a=_({},e,a),typeof a.expires=="number"&&(a.expires=new Date(Date.now()+a.expires*864e5)),a.expires&&(a.expires=a.expires.toUTCString()),r=encodeURIComponent(r).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var o="";for(var h in a)a[h]&&(o+="; "+h,a[h]!==!0&&(o+="="+a[h].split(";")[0]));return document.cookie=r+"="+c.write(s,r)+o}}function i(r){if(!(typeof document>"u"||arguments.length&&!r)){for(var s=document.cookie?document.cookie.split("; "):[],a={},o=0;o<s.length;o++){var h=s[o].split("="),d=h.slice(1).join("=");try{var f=decodeURIComponent(h[0]);if(a[f]=c.read(d,f),r===f)break}catch{}}return r?a[r]:a}}return Object.create({set:t,get:i,remove:function(r,s){t(r,"",_({},s,{expires:-1}))},withAttributes:function(r){return S(this.converter,_({},this.attributes,r))},withConverter:function(r){return S(_({},this.converter,r),this.attributes)}},{attributes:{value:Object.freeze(e)},converter:{value:Object.freeze(c)}})}var R=S(U,{path:"/"});const F=c=>{const e=window.innerWidth<768||window.outerWidth<768?"mobile":"desktop";return c===e},L=(c,e)=>{const t=!!e,i=String(c)==="true";return t===i},I="shg_geo_data";function B(c,e){const t=c-e;return Math.floor(t/(1e3*60*60*24))}function N(){if(new URLSearchParams(window.location.search).get("shg_geo_cache")==="false")return null;let e=null;try{const t=localStorage.getItem(I);if(t){const i=JSON.parse(t),r=Date.now();i.timestamp&&B(r,i.timestamp)<=7?e=i:localStorage.removeItem(I)}}catch(t){return console.error("Error reading geo data from cache:",t),localStorage.removeItem(I),null}return e}function q(c){let e=null;if(!c)return console.warn("Geo location API URL not configured."),e;try{const t=new XMLHttpRequest;t.open("GET",c,!1),t.send(null),t.status===200?(e=JSON.parse(t.responseText),e?(e.timestamp=Date.now(),localStorage.setItem(I,JSON.stringify(e))):(console.error("Geo API response parsed to null or undefined."),e=null)):console.error(`Geo API request failed with status: ${t.status}`)}catch(t){console.error("Error fetching geo data from API:",t)}return e}function Q(c){let e=null;try{const t=N();t?(e=t,console.debug("Loaded geo data from cache:",e)):(e=q(c),console.debug("Fetched geo data from API:",e))}catch(t){console.error("Error initializing geo data:",t),e=null}return e}const j=(c,e)=>{const{type:t,country_code:i,toponym_name:r,parent_name:s}=c||{},{country:a,region:o,city:h}=e||{};if(!t||!i||!e)return!1;switch(t){case"country":return a===i;case"region":return o===r&&a===i;case"city":return h===r&&o===s&&a===i;default:return console.debug("Unknown location type:",t),!1}},x=c=>typeof c!="string"?!1:document.referrer.toLowerCase().includes(c.toLowerCase()),$=c=>typeof c!="string"?!1:window.location.href.toLowerCase().includes(c.toLowerCase()),G=(c,e,t)=>{if(!e)return!1;const{expectedTimeInMillseconds:i,withinOrAfter:r}=c||{};if(typeof i!="number"||!r)return!1;const s=e.first_visit_timestamp;return r==="within"?s+i>t:s+i<t},K=(c,e,t)=>e?t-e.first_visit_timestamp<18e5===c:c===!0;function H(c,e){return c===e}const y=class y{constructor(e){n(this,"visitorDetails",null);n(this,"currentTime");n(this,"geoLocationApi");n(this,"customerId");n(this,"isB2B");n(this,"internalGeoData");n(this,"isGeoDataInitialized",!1);n(this,"checkers",{device:e=>F(e),logged_in:(e,t)=>L(e,this.customerId),new_visitor:(e,t)=>K(e,t.visitorDetails,t.currentTime),returning_visitor:(e,t)=>G(e,t.visitorDetails,t.currentTime),url_contains:e=>$(e),referrer_contains:e=>x(e),location:(e,t)=>j(e,t.geoData),b2b:e=>H(e,this.isB2B)});this.geoLocationApi=e.geoLocationApi,this.customerId=e.customerId,this.isB2B=e.isB2B,this.currentTime=Date.now(),this.initializeVisitorDetails()}initializeVisitorDetails(){var e;try{const t=localStorage.getItem(y.VISITOR_DETAILS_KEY);t&&(this.visitorDetails=JSON.parse(t),typeof((e=this.visitorDetails)==null?void 0:e.first_visit_timestamp)!="number"&&(console.warn("Invalid visitor details found in storage, resetting."),this.visitorDetails=null)),this.visitorDetails===null?(console.debug("Initializing new visitor details."),this.visitorDetails={first_visit_timestamp:this.currentTime},localStorage.setItem(y.VISITOR_DETAILS_KEY,JSON.stringify(this.visitorDetails))):console.debug("Loaded visitor details from storage:",this.visitorDetails)}catch(t){console.error("Error initializing visitor details:",t),localStorage.removeItem(y.VISITOR_DETAILS_KEY),this.visitorDetails={first_visit_timestamp:this.currentTime},localStorage.setItem(y.VISITOR_DETAILS_KEY,JSON.stringify(this.visitorDetails))}}check(e){const t=this.checkers[e.audience_type];if(!t)return console.warn(`Unknown audience type: ${e.audience_type}`),!1;e.audience_type==="location"&&(e.value=this.snakeCaseKeys(e.value),this.isGeoDataInitialized||(console.debug("Location check required, initializing geoData..."),this.internalGeoData=Q(this.geoLocationApi),this.isGeoDataInitialized=!0,console.debug("GeoData initialization result:",this.internalGeoData)));const i={geoData:this.internalGeoData===void 0?null:this.internalGeoData,visitorDetails:this.visitorDetails,currentTime:this.currentTime};try{const r=!!t(e.value,i);return console.debug("Audience check result:",{audience:e,internalContext:i,matched:r}),e.condition==="is_not"?!r:r}catch(r){return console.error("Error during audience check:",{audience:e,internalContext:i,error:r}),!1}}snakeCaseKeys(e){if(typeof e!="object")return e;const t={};for(const[i,r]of Object.entries(e)){const s=i.replace(/[A-Z]/g,a=>`_${a.toLowerCase()}`);t[s]=r}return t}};n(y,"VISITOR_DETAILS_KEY","_shg_ab_visitor_details");let k=y;class J{constructor(e,t){n(this,"buyItNowHandlerAttached",!1);n(this,"currentCartVariantId",null);n(this,"storefrontAccessToken");n(this,"shopDomain");n(this,"trackDispatchedSelection",(e,t)=>{const i=e&&e.isFirstAssignment===!1?"cache":t.distribution_method,r={shop_id:t.shop_id,optimization_id:e==null?void 0:e.optimization.id,variant_id:e==null?void 0:e.selectedVariant.id,details:{optimization_ids:t.optimization_ids,distribution_method:i,selection_details:t.selection_details,cache:t.cache,context:t.context,optimization_matches:t.optimization_matches}};this.trackingService.trackDispatch("dispatched",r)});this.trackingService=e,this.storefrontAccessToken=(t==null?void 0:t.storefrontAccessToken)??null,this.shopDomain=(t==null?void 0:t.shopDomain)??null,this.currentCartVariantId=(t==null?void 0:t.currentCartVariantId)??null,typeof document<"u"&&document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{this.attachPriceTestBuyItNowHandler()}):setTimeout(()=>{this.attachPriceTestBuyItNowHandler()},100)}async createCartAndGetCheckoutUrl(e,t,i){var o,h,d,f,V;if(!this.storefrontAccessToken||!this.shopDomain)return null;const r=`
      mutation cartCreate($input: CartInput!) {
        cartCreate(input: $input) {
          cart {
            id
            checkoutUrl
          }
          userErrors {
            field
            message
          }
        }
      }
    `,s=i?[{key:"shogun_variant_id",value:i}]:[],a={input:{lines:[{merchandiseId:`gid://shopify/ProductVariant/${e}`,quantity:t}],attributes:s}};try{const T=JSON.stringify({query:r,variables:a}),z=`https://${this.shopDomain}/api/2025-10/graphql.json`;console.debug("shogun: cartCreate request URL:",z),console.debug("shogun: cartCreate request body:",T);const b=await(await fetch(z,{method:"POST",headers:{"Content-Type":"application/json","X-Shopify-Storefront-Access-Token":this.storefrontAccessToken},body:T})).json();return console.debug("shogun: cartCreate full response:",JSON.stringify(b,null,2)),(d=(h=(o=b.data)==null?void 0:o.cartCreate)==null?void 0:h.cart)!=null&&d.checkoutUrl?(console.debug("shogun: cartCreate successful, checkoutUrl:",b.data.cartCreate.cart.checkoutUrl),b.data.cartCreate.cart.checkoutUrl):(console.error("shogun: cartCreate failed:",((V=(f=b.data)==null?void 0:f.cartCreate)==null?void 0:V.userErrors)||b.errors),null)}catch(T){return console.error("shogun: cartCreate error:",T),null}}async addToCartAndCheckout(e,t,i){const r={items:[{id:e,quantity:t}]};i&&(r.attributes={shogun_variant_id:i});try{const s=await fetch("/cart/add.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});s.ok?(console.debug("shogun: added to cart, redirecting to checkout"),window.location.href="/checkout"):console.error("shogun: cart add failed:",await s.text())}catch(s){console.error("shogun: cart add error:",s)}}attachPriceTestBuyItNowHandler(){if(this.buyItNowHandlerAttached)return;this.buyItNowHandlerAttached=!0;const e=async i=>{const r=new FormData(i);let s=r.get("id")||r.get("variant_id");if(console.debug("shogun: buy-it-now form data:",Object.fromEntries(r.entries())),console.debug("shogun: raw variantId from form:",s),!s){console.debug("shogun: no variant ID found for buy-it-now");return}if(s.includes("gid://")){const h=s.match(/\/(\d+)$/);h&&(s=h[1],console.debug("shogun: extracted numeric ID from GID:",s))}const a=parseInt(r.get("quantity")||"1",10)||1,o=this.currentCartVariantId;if(console.debug("shogun: buy-it-now details:",{variantId:s,quantity:a,cartVariantId:o,storefrontAccessToken:this.storefrontAccessToken?"***":null,shopDomain:this.shopDomain}),this.storefrontAccessToken&&this.shopDomain){console.debug("shogun: attempting cartCreate with merchandiseId:",`gid://shopify/ProductVariant/${s}`);const h=await this.createCartAndGetCheckoutUrl(s,a,o);if(h){console.debug("shogun: redirecting to cartCreate checkoutUrl (original cart preserved)"),window.location.href=h;return}}console.debug("shogun: falling back to cart add with cart variant"),await this.addToCartAndCheckout(s,a,o)};typeof document<"u"&&(()=>{document.addEventListener("click",i=>{const r=i.target;if(!r)return;const s=r.closest('[data-ab-price-test-payment-button="true"]');if(!s||!r.closest('shopify-buy-it-now-button, shopify-accelerated-checkout, [data-shopify="payment-button"]'))return;const o=s.closest("form");o&&(i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation(),e(o))},{capture:!0})})()}extractViewParamFromFullTemplateKey(e){const t=e.split("/").pop().split(".");return t.slice(1,t.length-1).join(".")}async handleRedirect(e){const t=new URL(window.location.href),i=new URL(window.location.href);if(e.optimization.scope==="theme")i.searchParams.set("preview_theme_id",e.selectedVariant.config.theme_id);else if(e.optimization.scope==="url_redirect")i.pathname=e.languageRootUrl!=="/"?e.languageRootUrl+e.selectedVariant.config.path:e.selectedVariant.config.path;else{const r=this.extractViewParamFromFullTemplateKey(e.selectedVariant.config.full_template_key);i.searchParams.set("view",r)}t.toString()===i.toString()?this.hideViewParam():this.redirectWithoutCache(i)}hideViewParam(){const e=new URL(window.location.href);e.searchParams.delete("view"),window.history.replaceState({},"",e.toString())}dispatch(e,t,i){let r=null,s=e.find(a=>a.current())||e[0];if(["price","product_details","checkout"].includes(s.optimization.scope))if(r=s,this.currentCartVariantId=t||s.selectedVariant.id,this.attachPriceTestBuyItNowHandler(),t)console.debug("shogun: price variant already assigned, returning");else{const a=s.selectedVariant.id;console.debug("shogun: assigning price variant");const o=JSON.stringify({attributes:{shogun_variant_id:a}}),h=new XMLHttpRequest;h.open("POST","/cart/update.js",!0),h.setRequestHeader("Content-Type","application/json"),h.onreadystatechange=()=>{if(h.readyState==4&&h.status==200){if(e[0].optimization.scope==="checkout")return;console.debug("shogun: reloading to reflect cart pricing");const d=new URL(window.location.href);this.redirectWithoutCache(d)}},h.send(o)}else{const a=e.find(h=>h.matchingVariant.id!==h.selectedVariant.id);if(console.debug("redirectingSelection",a),a&&(a.optimization.scope!=="url_redirect"||a.isFirstAssignment===!0||a.optimization.config.permanent_redirect===!0))return this.trackDispatchedSelection(a,i),this.handleRedirect(a);const o=new Set(e.map(h=>h.optimization.scope));(o.has("template")||o.has("page"))&&this.hideViewParam(),r=e.find(h=>h.current())||a||null}e.length>0&&!r&&(r=e[0]),(r||e.length>0)&&this.trackDispatchedSelection(r,i),e.filter(a=>a.current()).forEach(a=>{this.trackingService.trackVariantImpression(a.selectedVariant,a.optimization.type)})}redirectWithoutCache(e){typeof e=="string"&&(e=new URL(e)),e.searchParams.delete("cache"),document.referrer!=""&&sessionStorage.setItem(A,document.referrer),console.debug("shogun: redirecting to ",e),window.location.replace(e)}}class v{constructor(e){n(this,"optimization");n(this,"matchingVariant");n(this,"selectedVariant");n(this,"isFirstAssignment");n(this,"languageRootUrl");this.optimization=e.optimization,this.matchingVariant=e.matchingVariant,this.selectedVariant=e.selectedVariant,this.isFirstAssignment=e.isFirstAssignment,this.languageRootUrl=e.languageRootUrl}current(){return this.matchingVariant.id===this.selectedVariant.id}}const w=class w{constructor(){n(this,"ran",!1)}removePreviewBarIframe(){console.debug("Setting up preview bar iframe removal");const e=()=>{w.PREVIEW_BAR_IFRAME_IDS.forEach(t=>{const i=document.getElementById(t);i&&(console.debug(`Removing preview bar iframe with id: ${t}`),i.remove())})};e(),document.addEventListener("DOMContentLoaded",()=>{console.debug("DOM loaded, setting up mutation observer for preview bar");const t=new MutationObserver(i=>{i.forEach(r=>{r.addedNodes.forEach(s=>{if(s.nodeType===Node.ELEMENT_NODE){const a=s;w.PREVIEW_BAR_IFRAME_IDS.includes(a.id)&&(console.debug(`Detected and removing preview bar iframe with id: ${a.id} via observer`),a.remove())}})})});if(document.body)t.observe(document.body,{childList:!0,subtree:!0});else{const i=new MutationObserver(()=>{document.body&&(t.observe(document.body,{childList:!0,subtree:!0}),e(),i.disconnect())});i.observe(document.documentElement,{childList:!0})}e()})}run(){this.ran||(this.removePreviewBarIframe(),this.ran=!0)}};n(w,"PREVIEW_BAR_IFRAME_IDS",["preview-bar-iframe","PBarNextFrameWrapper"]);let P=w;const C="_shg_analytics_queue";class W{enqueue(e){const t={...e,id:crypto.randomUUID(),attempts:0,createdAt:Date.now()},i=this.readQueue();return i[t.category].push(t),this.writeQueue(i),t}all(){const e=this.readQueue();return[...e.shogun_load,...e.dispatcher].sort((t,i)=>t.createdAt-i.createdAt)}update(e){const t=this.readQueue(),i=t[e.category],r=i.findIndex(s=>s.id===e.id);r!==-1&&(i[r]=e,this.writeQueue(t))}remove(e){const t=this.readQueue(),i=t[e.category],r=i.findIndex(s=>s.id===e.id);r!==-1&&(i.splice(r,1),this.writeQueue(t))}findLatest(e){const i=this.readQueue()[e];if(i.length!==0)return i[i.length-1]}readQueue(){const e=localStorage.getItem(C);if(!e)return this.emptyQueue();try{const t=JSON.parse(e);return t.shogun_load||(t.shogun_load=[]),t.dispatcher||(t.dispatcher=[]),t}catch(t){return console.error("shogun: failed to parse analytics queue storage, resetting",t),localStorage.removeItem(C),this.emptyQueue()}}writeQueue(e){try{localStorage.setItem(C,JSON.stringify(e))}catch(t){console.error("shogun: failed to save analytics queue",t)}}emptyQueue(){return{shogun_load:[],dispatcher:[]}}}const u=class u{constructor(e,t,i,r,s,a){n(this,"publishable",!1);n(this,"allowed",null);n(this,"eventQueue",new W);n(this,"processingQueue",!1);n(this,"pendingProcess",!1);n(this,"processTimer",null);n(this,"trackVariantImpression",(e,t)=>{const i={page_type:this.pageType,page_id:this.pageId,app_type:t=="ab_test"?"ab_testing":"personalization",original_referrer:this.originalReferrer};i.optimization_id=e.optimization_id,i.variant_id=e.id,console.debug(`Tracking variant impression: optimization=${e.optimization_id}, variant=${e.id}`),this.enqueueShogunLoadEvent(i)});n(this,"trackPage",()=>{const e={page_type:this.pageType,page_id:this.pageId,app_type:"ab_testing"};this.enqueueShogunLoadEvent(e)});n(this,"trackDispatch",(e,t)=>{this.enqueueEvent({category:"dispatcher",event:e,data:t})});n(this,"enqueueEvent",e=>{console.debug("shogun: enqueueing tracking event",{category:e.category,event:"event"in e?e.event:void 0}),e.category==="shogun_load"&&(!this.publishable||this.allowed!==!0)&&console.debug("shogun: not ready, enqueueing shogun:load event");try{this.eventQueue.enqueue(e),this.scheduleProcessQueue()}catch(t){console.error("shogun: failed to enqueue analytics event",t)}});n(this,"enqueueShogunLoadEvent",e=>{this.enqueueEvent({category:"shogun_load",data:e})});n(this,"waitForPublishable",()=>{var i,r;let e=0;const t=()=>{var s,a;if(typeof((a=(s=window.Shopify)==null?void 0:s.analytics)==null?void 0:a.publish)>"u")if(e<=u.retryAttemptsLimit){setTimeout(t,u.retryIntervalInMs);return}else{console.warn("shogun:ts: Shopify analytics unavailable after 30s"),this.handleError("Error initializing TrackingService: Shopify analytics not available after 30s");return}console.debug("shogun:ts: publishable"),this.publishable=!0,this.scheduleProcessQueue()};(r=(i=window.Shopify)==null?void 0:i.analytics)!=null&&r.publish?(console.debug("shogun:ts: publishable"),this.publishable=!0):(console.debug("shogun:ts: analytics api not available yet, waiting..."),t())});n(this,"waitForConsent",()=>{var i,r;let e=0;const t=()=>{if(typeof window.Shopify>"u"&&e<=u.retryAttemptsLimit){setTimeout(t,u.retryIntervalInMs);return}window.Shopify.loadFeatures([{name:"consent-tracking-api",version:"0.1"}],s=>{var a;if(s&&s.length>0){let o=[];s.forEach(h=>{console.error(h),o.push(h.message)}),this.handleError(`Error initializing TrackingService: ${o.join(", ")}`)}else console.debug("shogun:ts: consent available"),this.handleConsentChange(((a=window.Shopify.customerPrivacy)==null?void 0:a.analyticsProcessingAllowed())??!1)})};(r=(i=window.Shopify)==null?void 0:i.customerPrivacy)!=null&&r.analyticsProcessingAllowed?(console.debug("shogun:ts: consent available"),this.allowed=window.Shopify.customerPrivacy.analyticsProcessingAllowed()):(console.debug("shogun:ts: privacy api not available yet, waiting..."),t())});n(this,"handleConsentChange",e=>{this.allowed=e,console.debug("shogun: analytics consent updated to: ",this.allowed),this.scheduleProcessQueue()});n(this,"scheduleProcessQueue",()=>{if(this.processingQueue){this.pendingProcess=!0;return}this.processingQueue=!0;try{this.processQueue()}catch(e){console.error("shogun: error processing analytics queue",e)}finally{this.processingQueue=!1,this.pendingProcess&&(this.pendingProcess=!1,this.scheduleProcessQueue())}});n(this,"scheduleProcessQueueAfter",e=>{this.processTimer||(this.processTimer=setTimeout(()=>{this.processTimer=null,this.scheduleProcessQueue()},e))});n(this,"handleError",e=>{let t,i;const r=this.eventQueue.findLatest("shogun_load");r&&(t=r.data.optimization_id,i=r.data.variant_id),this.trackDispatchFallback("errored",{shop_id:this.shopId,dispatcher_session_id:this.dispatcherSessionId,optimization_id:t,variant_id:i,details:{error:e}})});n(this,"dispatcherFallbackReady",e=>e.category!=="dispatcher"?!1:Date.now()-e.createdAt>=u.dispatchFallbackDelayInMs);n(this,"trackDispatchFallback",(e,t)=>{console.debug(`shogun: sending dispatch:${e} via fallback`),t.name=e,fetch(`${this.analyticsUrl}/dispatcher/${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),keepalive:!0})});n(this,"prepareFallbackPayload",e=>{const t=this.clonePayload(e);return t.shop_id=t.shop_id||this.shopId,t.dispatcher_session_id=this.dispatcherSessionId,t.details||(t.details={}),t});n(this,"clonePayload",e=>{try{return JSON.parse(JSON.stringify(e))}catch{return e}});this.shopId=e,this.pageType=t,this.pageId=i,this.originalReferrer=r,this.analyticsUrl=s,this.dispatcherSessionId=a,this.waitForPublishable(),this.waitForConsent(),document.addEventListener("visitorConsentCollected",o=>{this.handleConsentChange(o.detail.analyticsAllowed)}),this.scheduleProcessQueue()}processQueue(){console.debug("shogun: processing queue");const e=this.eventQueue.all();let t=!1;for(const i of e){if(this.shouldDropEvent(i)){this.eventQueue.remove(i);continue}if(this.isWithinBackoffWindow(i)){t=!0;continue}if(!this.isEventReady(i)){t=!0;continue}let r="success";try{r=this.deliverEvent(i)}catch(s){console.error("shogun: error delivering analytics event",s),r="retry"}r==="success"||r==="drop"?this.eventQueue.remove(i):(i.attempts+=1,i.lastAttemptedAt=Date.now(),this.eventQueue.update(i),t=!0)}t&&this.scheduleProcessQueueAfter(u.queueRetryDelayInMs)}shouldDropEvent(e){return Date.now()-e.createdAt>u.maxQueueAgeInMs||e.attempts>=u.maxQueueAttempts||e.category==="dispatcher"&&!e.event}isWithinBackoffWindow(e){if(!e.lastAttemptedAt)return!1;const t=u.queueRetryDelayInMs*Math.pow(2,Math.min(e.attempts,u.maxQueueAttempts));return Date.now()-e.lastAttemptedAt<t}isEventReady(e){return e.category==="shogun_load"?this.publishable&&this.allowed===!0:e.category==="dispatcher"?this.allowed===!0&&this.publishable?!0:this.dispatcherFallbackReady(e):!1}deliverEvent(e){return e.category==="shogun_load"?this.deliverShogunLoad(e):this.deliverDispatch(e)}deliverShogunLoad(e){const t=e.data;try{if(console.debug("Firing shogun:load event",t),!window.Shopify.analytics.publish)throw new Error("Shopify analytics publish is not available");return window.Shopify.analytics.publish("shogun:load",t),"success"}catch(i){return console.error("Error publishing shogun:load event:",i),"retry"}}deliverDispatch(e){if(e.category!=="dispatcher"||!e.event)return"drop";if(this.allowed===!0&&this.publishable){const i=`shogun:dispatcher:${e.event}`;try{if(console.debug(`Firing ${i} event`,e.data),!window.Shopify.analytics.publish)throw new Error("Shopify analytics publish is not available");return window.Shopify.analytics.publish(i,e.data),"success"}catch(r){console.error(`Error publishing ${i} event:`,r);const s=this.prepareFallbackPayload(e.data);return s.details||(s.details={}),s.details.error=`Error publishing ${i} event: ${r.message}`,this.trackDispatchFallback(e.event,s),"success"}}if(!this.dispatcherFallbackReady(e))return"retry";const t=this.prepareFallbackPayload(e.data);return this.trackDispatchFallback(e.event,t),"success"}};n(u,"retryIntervalInMs",250),n(u,"retryAttemptsLimit",3e4/u.retryIntervalInMs),n(u,"queueRetryDelayInMs",1e3),n(u,"maxQueueAttempts",5),n(u,"maxQueueAgeInMs",24*60*60*1e3),n(u,"dispatchFallbackDelayInMs",30*1e3);let D=u;const A="_shg_referrer",l=class l{constructor(e){n(this,"shopId");n(this,"optimizations");n(this,"currentThemeId");n(this,"defaultThemeId");n(this,"pageId");n(this,"pageType");n(this,"currentPartialTemplateKey");n(this,"distributionMethod");n(this,"cachedOptimizations");n(this,"audienceChecker");n(this,"personalizations");n(this,"abTests");n(this,"dispatcher");n(this,"trackingService");n(this,"currentPath");n(this,"themeTestHandler");n(this,"currentCartVariantId");n(this,"languageRootUrl");n(this,"dispatcherSessionId");n(this,"originalReferrer");n(this,"inAudience",e=>this.audienceChecker.check(e));if(this.originalReferrer=sessionStorage.getItem(A),this.originalReferrer){sessionStorage.removeItem(A),console.debug("shogun: retaining original referrer: ",this.originalReferrer);try{Object.defineProperty(document,"referrer",{get:()=>this.originalReferrer})}catch(a){console.debug("shogun: failed to set original referrer via `Object.defineProperty`"),console.error(a);try{window.document.__defineGetter__("referrer",()=>this.originalReferrer)}catch(o){console.debug("shogun: failed to set original referrer via `__defineGetter__`"),console.error(o)}}}this.shopId=e.shopId,this.currentThemeId=e.currentThemeId,this.defaultThemeId=e.defaultThemeId,this.currentCartVariantId=e.currentCartVariantId;const t=e.optimizations||[];e.defaultThemeId&&e.defaultThemeId!==this.currentThemeId?this.optimizations=t.filter(a=>a.scope==="price"||a.scope==="product_details"||a.variants.some(o=>o.config.theme_id===this.currentThemeId)):this.optimizations=t,this.personalizations=this.optimizations.filter(a=>a.type==="personalization"),this.abTests=this.optimizations.filter(a=>a.type==="ab_test"),this.distributionMethod=e.distributionMethod||l.DEFAULT_DISTRIBUTION_METHOD,this.pageId=e.pageId,this.pageType=e.pageType,this.languageRootUrl=e.languageRootUrl;const i=this.pageType==="metaobject"?"templates/metaobject/":"templates/",r=[e.templateName,e.templateSuffix].filter(Boolean).join(".");this.currentPartialTemplateKey=i+r,this.currentPath=window.location.pathname,this.cachedOptimizations=JSON.parse(localStorage.getItem(l.OPTIMIZATIONS_CACHE_KEY)||"{}"),this.audienceChecker=new k(e),e.sessionIdOverride?this.dispatcherSessionId=e.sessionIdOverride:(this.dispatcherSessionId=R.get(l.DISPATCHER_SESSION_COOKIE)||crypto.randomUUID(),R.set(l.DISPATCHER_SESSION_COOKIE,this.dispatcherSessionId,{path:"/",expires:1/48})),this.trackingService=new D(this.shopId,this.pageType,this.pageId,this.originalReferrer,e.analyticsUrl,this.dispatcherSessionId);const s=new P;this.themeTestHandler=s,this.dispatcher=new J(this.trackingService,{storefrontAccessToken:e.storefrontAccessToken,shopDomain:e.shopDomain,currentCartVariantId:e.currentCartVariantId})}getOptimizationPriority(e){return{theme:1,template:2,page:3,url_redirect:4,price:5,product_details:6,checkout:7}[e.scope]}sortMatches(e){return[...e].sort((t,i)=>{const r=this.getOptimizationPriority(t.optimization),s=this.getOptimizationPriority(i.optimization);return r===s?0:r-s})}audienceMatchesCurrentVisitor(e){const t=e.audiences||[];return t.length===0?!0:e.audiences_condition==="any"?t.some(this.inAudience):t.every(this.inAudience)}configAudiencesMatch(e,t){const i=e.audiences||[],r=t.audiences||[];if(i.length!==r.length)return!1;const s=i.map(o=>JSON.stringify(o)),a=r.map(o=>JSON.stringify(o));return!(s.some(o=>!a.includes(o))||a.some(o=>!s.includes(o))||i.length>1&&e.audiences_condition!==t.audiences_condition)}getCachedVariant(e){const t=this.cachedOptimizations[e.id];if(!t)return;const i=typeof t=="string"?t:t.variantId;return e.variants.find(r=>r.id===i)}setCachedVariant(e,t){const i={variantId:t.id,sessionId:this.dispatcherSessionId};e.scope==="theme"&&t.config.theme_id&&(i.themeId=t.config.theme_id),this.cachedOptimizations[e.id]=i,console.debug("setCachedVariant",e.id,t.id),localStorage.setItem(l.OPTIMIZATIONS_CACHE_KEY,JSON.stringify(this.cachedOptimizations))}extractPartialTemplateKeyFromFullTemplateKey(e){if(!e)return;const t=e.split(".");return t.length<2?e:t.slice(0,-1).join(".")}matchesAnyAttributeOfCurrentPage(e,t){const i=this.checkTemplateMatch(t),r=this.checkThemeMatch(e,t),s=this.checkPageMatch(e),a=this.checkPathMatch(t),o=this.checkPriceMatch(e,t),h=this.checkProductDetailsMatch(e,t),d=this.checkCheckoutMatch(e,t);return r||i&&s||a||o||h||d}getMatchingVariant(e,t=void 0){var s;const i=e.config,r=(s=t==null?void 0:t.selectedVariant)==null?void 0:s.config;for(const a of e.variants){if(!this.matchesAnyAttributeOfCurrentPage(e,a))continue;const o=e.type==="ab_test"?e.config:a.config;if(this.audienceMatchesCurrentVisitor(o)&&!(r&&!this.configAudiencesMatch(i,r)))return a}}getPersonalizationMatches(){const e=[];for(const t of this.personalizations){const i=this.getMatchingVariant(t);i&&e.push({optimization:t,matchingVariant:i})}return e}getPrioritizedNonDefaultPersonalizationSelection(){const e=this.getPersonalizationMatches();if(e.length===0)return;const t=this.sortMatches(e);for(const i of t){const s=i.optimization.variants.sort((a,o)=>a.position-o.position).find(a=>!a.config.original&&this.audienceMatchesCurrentVisitor(a.config));if(s)return new v({optimization:i.optimization,matchingVariant:i.matchingVariant,selectedVariant:s,isFirstAssignment:!0,languageRootUrl:this.languageRootUrl})}}getDefaultPersonalizationSelectionsForImpressionTracking(e){return this.getPersonalizationMatches().filter(r=>r.matchingVariant.config.original&&r.optimization.id!==(e==null?void 0:e.optimization.id)).map(r=>new v({optimization:r.optimization,matchingVariant:r.matchingVariant,selectedVariant:r.matchingVariant,isFirstAssignment:!0,languageRootUrl:this.languageRootUrl}))}getRandomVariantForOptimization(e){const t=`${this.dispatcherSessionId}-${e.id}`,r=this.hashWithDjb2(t)%l.DEFAULT_NUMBER_OF_BINS;let s=0;for(const a of e.variants)if(s+=l.DEFAULT_NUMBER_OF_BINS*(a.config.percentage||0)/100,r<s)return a;return e.variants[0]}hasAnyCachedVariants(){return this.abTests.some(e=>!!this.cachedOptimizations[e.id])}getGreedySelections(e){const t=e[Math.floor(Math.random()*e.length)],i=t.cachedVariant||this.getRandomVariantForOptimization(t.optimization);return[new v({optimization:t.optimization,matchingVariant:t.matchingVariant,selectedVariant:i,isFirstAssignment:!t.cachedVariant,languageRootUrl:this.languageRootUrl})]}userBin(){const e=this.dispatcherSessionId;return e?this.hashWithDjb2(e)%l.DEFAULT_NUMBER_OF_BINS:0}hashWithDjb2(e){let t=5381;for(let i=0;i<e.length;i++)t=(t<<5)-t+e.charCodeAt(i),t|=0;return Math.abs(t)}getVariantForUserBin(){const e=this.userBin(),t=this.abTests.flatMap(r=>r.variants);let i=0;for(const r of t)if(i+=l.DEFAULT_NUMBER_OF_BINS*(r.traffic_percentage||0)/100,e<i)return r;return null}getEvenSelections(e){const t=this.getVariantForUserBin();if(!t)return[];const i=e.find(r=>r.optimization.variants.some(s=>s.id===t.id));return i?[new v({optimization:i.optimization,matchingVariant:i.matchingVariant,selectedVariant:t,isFirstAssignment:!i.cachedVariant,languageRootUrl:this.languageRootUrl})]:[]}getAbTestMatches(e){const t=[];return this.abTests.forEach(i=>{const r=this.getMatchingVariant(i,e);if(r){const s=this.getCachedVariant(i);(r.config.original||s)&&t.push({optimization:i,matchingVariant:r,cachedVariant:s})}}),t}getAbTestSelections(e){const t=this.getAbTestMatches(e);if(t.length===0)return[];const i=t.find(r=>!!r.cachedVariant);if(!i&&this.hasAnyCachedVariants())return[];if(i)return[new v({optimization:i.optimization,matchingVariant:i.matchingVariant,selectedVariant:i.cachedVariant,isFirstAssignment:!1,languageRootUrl:this.languageRootUrl})];switch(this.distributionMethod){case"greedy":return this.getGreedySelections(t);case"even":return this.getEvenSelections(t);default:throw new Error(`Unknown distribution method: ${this.distributionMethod}`)}}isBot(){const e=navigator.userAgent,t=O(e);return console.debug("Bot testing with user agent:",e),t}hasValidCachedSessionForCurrentTheme(){return Object.values(this.cachedOptimizations).some(e=>typeof e=="string"?!1:e.themeId===this.currentThemeId&&e.sessionId===this.dispatcherSessionId)}shouldClearStaleThemePreview(){return!(localStorage.getItem("_shg_is_merchant")||this.currentThemeId===this.defaultThemeId||!this.defaultThemeId||this.optimizations.some(t=>t.scope==="theme"&&t.variants.some(i=>i.config.theme_id===this.currentThemeId))||this.hasValidCachedSessionForCurrentTheme())}clearStaleThemePreview(){const e=new URL(window.location.href);e.searchParams.set("preview_theme_id",this.defaultThemeId),console.debug("shogun: clearing stale theme preview, redirecting to default theme"),window.location.replace(e.toString())}handleThemeReview(){const t=new URLSearchParams(location.search).get("shgpvid"),i=sessionStorage.getItem("_shg_preview_variant_id");if(i&&(!t||i==t)){console.debug(`shogun: theme review in progress, viewing variant: ${i}`);const r=document.getElementById("shogun-price-test-preview");if(!r){console.debug("shogun: sidebar not found!!!");return}const s=r.content.cloneNode(!0);document.addEventListener("DOMContentLoaded",()=>{document.body.style.paddingLeft="360px",document.body.prepend(s),typeof window.restoreCollapsedState=="function"&&window.restoreCollapsedState()});return}else if(t&&(!i||i!=t)){console.debug(`shogun: theme review in progress, setting variant: ${t}`),sessionStorage.setItem("_shg_preview_variant_id",t);const r=JSON.stringify({attributes:{shogun_variant_id:t}}),s=new XMLHttpRequest;s.open("POST","/cart/update.js",!0),s.setRequestHeader("Content-Type","application/json"),s.onreadystatechange=()=>{s.readyState==4&&s.status==200&&(console.debug("shogun: reloading to reflect cart pricing"),location=location)},s.send(r)}}run(){let e=null,t=this.distributionMethod,i=[];const r=(s,a={})=>{var h,d;const o=s&&s.isFirstAssignment===!1?"cache":t;return{shop_id:this.shopId,optimization_id:(h=s==null?void 0:s.optimization)==null?void 0:h.id,variant_id:(d=s==null?void 0:s.selectedVariant)==null?void 0:d.id,details:{optimization_ids:this.optimizations.map(f=>f.id),distribution_method:o,selection_details:i,...a}}};try{if(this.isBot()){console.debug("Bot traffic detected, optimizer disabled");return}if(this.shouldClearStaleThemePreview()){this.clearStaleThemePreview();return}this.handleThemeReview();const s=this.getPrioritizedNonDefaultPersonalizationSelection(),a=this.getAbTestSelections(s),o=[];s&&o.push(s),o.push(...a),o.push(...this.getDefaultPersonalizationSelectionsForImpressionTracking(s)),localStorage.getItem("_shg_is_merchant")||this.themeTestHandler.run(),e=o.find(d=>d.matchingVariant.id===d.selectedVariant.id)||null,e&&!e.isFirstAssignment&&(t="cache"),i=o.map(d=>({optimization_id:d.optimization.id,selected_variant_id:d.selectedVariant.id,matching_variant_id:d.matchingVariant.id}));const h={shop_id:this.shopId,optimization_ids:this.optimizations.map(d=>d.id),selection_details:i,distribution_method:t,cache:{...this.cachedOptimizations},context:{template_key:this.currentPartialTemplateKey,theme_id:this.currentThemeId,page_type:this.pageType,page_id:this.pageId},optimization_matches:this.buildOptimizationMatches(s)};if(a.forEach(d=>{this.setCachedVariant(d.optimization,d.selectedVariant)}),o.length===0){this.abTests.length>0&&(this.trackingService.trackPage(),this.trackingService.trackDispatch("skipped",r(e)));return}this.dispatcher.dispatch(o,this.currentCartVariantId,h)}catch(s){this.trackingService.trackDispatch("errored",r(e,{error:s.message}))}}getCurrentPathWithoutLanguagePrefix(){return this.languageRootUrl==="/"||!this.currentPath.startsWith(this.languageRootUrl)?this.currentPath:this.currentPath.substring(this.languageRootUrl.length)||"/"}checkTemplateMatch(e){return this.extractPartialTemplateKeyFromFullTemplateKey(e.config.full_template_key)===this.currentPartialTemplateKey}checkThemeMatch(e,t){return e.scope==="theme"&&t.config.theme_id===this.currentThemeId}checkPageMatch(e){const{page_type:t,page_id:i}=e.config,r=!t||t===this.pageType,s=!i||i===this.pageId;return e.scope!=="url_redirect"&&r&&s}checkPathMatch(e){const t=e.config.path;if(!t)return!1;const i=this.getCurrentPathWithoutLanguagePrefix();return decodeURIComponent(t)===decodeURIComponent(i)}checkPriceMatch(e,t){return e.scope!=="price"?!1:!this.currentCartVariantId||this.currentCartVariantId===t.id}checkProductDetailsMatch(e,t){return e.scope!=="product_details"?!1:!this.currentCartVariantId||this.currentCartVariantId===t.id}checkCheckoutMatch(e,t){return e.scope!=="checkout"?!1:!this.currentCartVariantId||this.currentCartVariantId===t.id}getDetailedMatchingInfo(e,t,i){const{page_type:r,page_id:s}=e.config,a=!r||r===this.pageType,o=!s||s===this.pageId,h=e.type==="ab_test"?e.config:t.config,d=i?this.configAudiencesMatch(e.config,i.selectedVariant.config):!1;return{matches_template:this.checkTemplateMatch(t),matches_theme:this.checkThemeMatch(e,t),matches_page_type:a,matches_page_id:o,matches_page:this.checkPageMatch(e),matches_path:this.checkPathMatch(t),matches_price:this.checkPriceMatch(e,t),matches_audience:this.audienceMatchesCurrentVisitor(h),matches_personalization_config:d}}buildOptimizationMatches(e){const t={};for(const i of this.optimizations)if(t[i.id]={},i.variants&&Array.isArray(i.variants))for(const r of i.variants)t[i.id][r.id]=this.getDetailedMatchingInfo(i,r,e);return t}};n(l,"DEFAULT_NUMBER_OF_BINS",1e4),n(l,"DEFAULT_DISTRIBUTION_METHOD","greedy"),n(l,"OPTIMIZATIONS_CACHE_KEY","_shg_ab_optimizations_cache"),n(l,"DISPATCHER_SESSION_COOKIE","_shg_dispatcher_session");let E=l;window.ShogunOptimizer=E})();

  {% endraw %}
</script>

{%- comment -%}
  =====================================================
  SHOP CONFIGURATION
  Set up namespaces, variant IDs, and payment detection
  =====================================================
{%- endcomment -%}
{%- assign shogun_app_namespace = 'app--214825828353' -%}
{%- assign shogun_variant_id = cart.attributes.shogun_variant_id -%}

{%- comment -%} Detect Klarna payment support {%- endcomment -%}
{%- assign optimizer_supports_klarna = false -%}
{%- if shop.enabled_payment_types != blank -%}
  {%- for payment_type in shop.enabled_payment_types -%}
    {%- assign payment_type_downcase = payment_type | downcase -%}
    {%- if payment_type_downcase contains 'klarna' -%}
      {%- assign optimizer_supports_klarna = true -%}
      {%- break -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}
{%- if optimizer_supports_klarna == false and shop.enabled_payment_gateways != blank -%}
  {%- for payment_gateway in shop.enabled_payment_gateways -%}
    {%- assign gateway_name = payment_gateway.name | default: payment_gateway -%}
    {%- assign gateway_value = gateway_name | downcase -%}
    {%- if gateway_value contains 'klarna' -%}
      {%- assign optimizer_supports_klarna = true -%}
      {%- break -%}
    {%- endif -%}
  {%- endfor -%}
{%- endif -%}

{%- comment -%}
  =====================================================
  PRICE TEST CONFIGURATION
  Only rendered when shogun_variant_id is present
  =====================================================
{%- endcomment -%}
{%- if shogun_variant_id != nil -%}
  {%- assign price_tests = shop.metafields.app--214825828353.price-tests -%}
  {%- assign optimization_config = nil -%}
  {% for optimization in price_tests.value %}
    {% for variants in optimization.variants %}
      {% if variants.id == shogun_variant_id %}
        {% assign optimization_config = optimization %}
      {% endif %}
    {% endfor %}
  {% endfor %}

  {%- assign shg_is_product_details = false -%}
  {%- if optimization_config.scope == 'product_details' -%}
    {%- assign shg_is_product_details = true -%}
  {%- endif -%}

  {%- comment -%}
    =====================================================
    SVG ICON DEFINITIONS
    =====================================================
  {%- endcomment -%}
  {%- capture variant_arrow_symbol -%}
    <svg class="shg-preview__variant-arrow" viewBox="0 0 10 12" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M4.92296 10.5227C4.55973 10.8482 4.55973 11.3758 4.92296 11.7012C5.28619 12.0267 5.8751 12.0267 6.23833 11.7012L9.33869 8.92346C9.70192 8.59802 9.70192 8.07038 9.33869 7.74494L6.23833 4.96717C5.8751 4.64173 5.28619 4.64173 4.92296 4.96717C4.55973 5.2926 4.55973 5.82024 4.92296 6.14568L6.43552 7.50087L4.65054 7.50087C3.10948 7.50087 1.86021 6.38158 1.86021 5.00087L1.86021 0.834201C1.86021 0.373964 1.44379 0.000867717 0.930106 0.000867762C0.416423 0.000867807 -4.79388e-07 0.373964 -4.39152e-07 0.834201L-6.07103e-07 5.00087C-4.05927e-07 7.30205 2.08212 9.16753 4.65054 9.16753L6.43552 9.16753L4.92296 10.5227Z" fill="currentColor"/>
    </svg>
  {%- endcapture -%}

  {%- capture eye_symbol -%}
    <svg class="shg-preview__product-eye" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M10 4.5C6.5 4.5 3.5 7 2 10C3.5 13 6.5 15.5 10 15.5C13.5 15.5 16.5 13 18 10C16.5 7 13.5 4.5 10 4.5Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
      <circle cx="10" cy="10" r="2.5" stroke="currentColor" stroke-width="1.5" fill="none"/>
    </svg>
  {%- endcapture -%}

  {%- capture info_icon_symbol -%}
    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none">
      <rect width="28" height="28" fill="#E0F0FF" rx="8"/>
      <path fill="#00527C" d="M14 18a.75.75 0 0 1-.75-.75v-3.5a.75.75 0 0 1 1.5 0v3.5A.75.75 0 0 1 14 18ZM13 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0Z"/>
      <path fill="#00527C" fill-rule="evenodd" d="M21 14a7 7 0 1 1-14 0 7 7 0 0 1 14 0Zm-1.5 0a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0Z" clip-rule="evenodd"/>
    </svg>
  {%- endcapture -%}

{%- capture caret_symbol -%}
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="none"><path fill-rule="evenodd" clip-rule="evenodd" d="M6.23966 11.7996C6.5432 12.0814 7.01775 12.0639 7.2996 11.7603L10 8.85221L12.7004 11.7603C12.9823 12.0639 13.4568 12.0814 13.7603 11.7996C14.0639 11.5177 14.0815 11.0432 13.7996 10.7397L10.5496 7.23966C10.4077 7.08683 10.2086 7 10 7C9.79145 7 9.59232 7.08683 9.45041 7.23966L6.20041 10.7397C5.91856 11.0432 5.93613 11.5177 6.23966 11.7996Z" fill="#4A4A4A"/></svg>
{%- endcapture -%}


  {%- comment -%}
    =====================================================
    PRODUCT PAGE: PRICE AND PRODUCT DETAILS TEST PRICING DATA
    =====================================================
  {%- endcomment -%}
  {% if product %}
    {%- assign product_pricing_metafield = product.metafields[shogun_app_namespace]['product-pricing'] -%}
    {%- assign product_pricing_array = nil -%}
    {% if product_pricing_metafield and product_pricing_metafield.value %}
      {% assign product_pricing_array = product_pricing_metafield.value %}
    {% endif %}

    {%- comment -%} Primary payload: per-variant metafields + product-level default {%- endcomment -%}
    <script type="application/json" id="shg-price-test-pricing">
      {
        "shogunVariantId": {{ shogun_variant_id | json }},
        "variants": {
          {% assign first_pricing_entry = true %}
          {% for variant in product.variants %}
            {% assign shogun_variant_pricing = variant.metafields[shogun_app_namespace]['product-variant-pricing'] %}
            {% if shogun_variant_pricing and shogun_variant_pricing.value %}
              {% assign matched_pricing = shogun_variant_pricing.value | find: 'shogun_variant_id', shogun_variant_id %}
              {% if matched_pricing %}
                {% unless first_pricing_entry %},{% endunless %}
                "{{ variant.id }}": {{ matched_pricing | json }}
                {% assign first_pricing_entry = false %}
              {% endif %}
            {% endif %}
          {% endfor %}
        },
        "productPricing": {% if product_pricing_array %}{{ product_pricing_array | json }}{% else %}null{% endif %}
      }
    </script>


    {%- comment -%} Fallback payload: build from optimization_config (covers draft preview & missing metafields) {%- endcomment -%}
    {% assign current_product_config = nil %}
    {% if optimization_config %}
      {% for p in optimization_config.products %}
        {% if p.id == product.id %}
          {% assign current_product_config = p %}
        {% endif %}
      {% endfor %}
    {% endif %}

    {% if current_product_config %}
      <script type="application/json" id="shg-price-test-pricing-fallback">
        {
          "shogunVariantId": {{ shogun_variant_id | json }},
          "variantPricing": {
            {% for vp in current_product_config.variant_pricing %}
              "{{ vp.id }}": { "test_price": {{ vp.test_price | json }}, "original_price": {{ vp.original_price | json }} }{% unless forloop.last %},{% endunless %}
            {% endfor %}
          }
        }
      </script>
    {% endif %}
  {% endif %}

  {%- comment -%} Include Klarna support script if enabled {%- endcomment -%}
  {% if optimizer_supports_klarna %}
    <script>
(function () {
  if (window.__shgKlarnaLite) return;

  // ---------- tiny helpers ----------
  function isArray(v){ return Array.isArray ? Array.isArray(v) : Object.prototype.toString.call(v)==='[object Array]'; }
  function findEntry(list, pred){ if(!isArray(list)) return null; for(var i=0;i<list.length;i++) if(pred(list[i])) return list[i]; return null; }
  function toCents(x){ var n = Math.round(parseFloat(x) * 100); return (isFinite(n) && n >= 0) ? n : null; }

  // ---------- read test amount from your JSON blobs ----------
  var dataNode = document.getElementById('shg-price-test-pricing');
  var defaultCents = null;     // chosen product price (your test price)
  var priceMap = {};           // per-variant overrides if provided

  if (dataNode) {
    try {
      var payload = JSON.parse(dataNode.textContent || dataNode.innerHTML || '{}');

      // 1) Main product price (chosen/test price for this shogunVariantId)
      if (payload && payload.shogunVariantId && isArray(payload.productPricing)) {
        var chosen = findEntry(payload.productPricing, function (e){ return e.shogun_variant_id === payload.shogunVariantId; })
                 || findEntry(payload.productPricing, function (e){ return e.original; });
        if (chosen && chosen.price != null) defaultCents = toCents(chosen.price);
      }

      // 2) Optional per-variant map (if present)
      var variants = (payload && payload.variants) || {};
      Object.keys(variants).forEach(function(vid){
        var entries = variants[vid];
        if (!isArray(entries)) return;
        var match = findEntry(entries, function (e){return e.shogun_variant_id === payload.shogunVariantId;})
                 || findEntry(entries, function (e){return e.original;});
        if (match && match.price != null) {
          var cents = toCents(match.price);
          if (cents != null) priceMap[String(vid)] = cents;
        }
      });
    } catch(_){}
  }

  // Fallback blob (optional)
  if (!Object.keys(priceMap).length && defaultCents == null) {
    var fb = document.getElementById('shg-price-test-pricing-fallback');
    if (fb) {
      try {
        var fbPayload = JSON.parse(fb.textContent || '{}');
        if (fbPayload && fbPayload.variantPricing) {
          Object.keys(fbPayload.variantPricing).forEach(function(id){
            var vp = fbPayload.variantPricing[id];
            var chosen = (vp && (vp.test_price != null ? vp.test_price : vp.original_price));
            var c = toCents(chosen);
            if (c != null) priceMap[String(id)] = c;
          });
        }
      } catch(_){}
    }
  }

  // Final amount resolver:
  function resolveOverrideCents(){
    if (typeof defaultCents === 'number') return defaultCents;
    var ids = Object.keys(priceMap);
    if (ids.length) return priceMap[ids[0]];
    return null;
  }

  // ---------- (A) keep DOM placements in sync ----------
  function resyncDom(){
    var amt = resolveOverrideCents();
    if (amt == null) return;

    // Set both DOM attributes (safe on DOM)
    var nodes = document.querySelectorAll('klarna-placement,[data-klarna-osm]');
    for (var i=0;i<nodes.length;i++){
      nodes[i].setAttribute('data-purchase-amount', String(amt));
      nodes[i].setAttribute('data-payment-amount',  String(amt));
    }

    // Nudge OSM to re-render with the enforced amount
    try {
      if (window.KlarnaOnsiteService && typeof window.KlarnaOnsiteService.push === 'function') {
        window.KlarnaOnsiteService.push({ event: 'update', purchaseAmount: amt, paymentAmount: amt });
      }
    } catch(_){}
  }

  // Guard direct attribute writes so Klarna can't revert them
  (function patchSetAttribute(){
    var proto = Element.prototype;
    var orig = proto.setAttribute;
    if (!orig || proto.__shgSetAttrPatched) return;
    proto.setAttribute = function(name, value){
      try {
        var n = String(name || '').toLowerCase();
        if ((this && this.nodeType === 1) && (n === 'data-purchase-amount' || n === 'purchase-amount' || n === 'data-payment-amount' || n === 'payment-amount')) {
          var amt = resolveOverrideCents();
          return orig.call(this, name, String(amt != null ? amt : value));
        }
      } catch(_){}
      return orig.call(this, name, value);
    };
    proto.__shgSetAttrPatched = true;
  })();

  // Snap back any attribute changes (e.g., after modal closes)
  (function installObserver(){
    try {
      var obs = new MutationObserver(function(records){
        var amt = resolveOverrideCents();
        if (amt == null) return;
        for (var i=0;i<records.length;i++){
          var r = records[i];
          if (r.type !== 'attributes' || !r.target) continue;
          var name = (r.attributeName || '').toLowerCase();
          if (name && (name === 'data-purchase-amount' || name === 'purchase-amount' || name === 'data-payment-amount' || name === 'payment-amount')) {
            var cur = r.target.getAttribute(r.attributeName);
            var want = String(amt);
            if (cur !== want) r.target.setAttribute(r.attributeName, want);
          }
        }
      });
      obs.observe(document.documentElement, {
        subtree: true,
        attributes: true,
        attributeFilter: ['data-purchase-amount','purchase-amount','data-payment-amount','payment-amount']
      });
    } catch(_){}
  })();

  // ---------- (B) force amount in Klarna network calls (no duplicates) ----------
  function whichAmountKey(url){
    // Prefer the key already present; otherwise infer from placement_key
    if (url.searchParams.has('purchase_amount')) return 'purchase_amount';
    if (url.searchParams.has('payment_amount'))  return 'payment_amount';

    var pk = url.searchParams.get('placement_key') || '';
    // Known defaults:
    if (/payment-calculator-interstitial/i.test(pk)) return 'purchase_amount';
    if (/credit-promotion-badge/i.test(pk))         return 'payment_amount';

    // Fallback: default to purchase_amount
    return 'purchase_amount';
  }

  function forceAmountInUrl(u){
    try{
      var url = (u instanceof Request) ? new URL(u.url, location.href) : new URL(String(u), location.href);
      var isKlarnaMsg = /js\.klarna\.com.*\/(cma|eu\/cma)\/v\d+\/messaging/i.test(url.href) || /klarna.*\/messaging/i.test(url.href);
      if (!isKlarnaMsg) return null;

      var amt = resolveOverrideCents();
      if (amt == null) return null;

      // Decide exactly ONE param to set
      var key = whichAmountKey(url);
      url.searchParams.set(key, String(amt));

      // And IMPORTANT: remove the other key if present to avoid "duplicated" error
      var other = key === 'purchase_amount' ? 'payment_amount' : 'purchase_amount';
      url.searchParams.delete(other);

      return url.toString();
    }catch(_){ return null; }
  }

  // fetch() patch
  (function patchFetch(){
    try {
      var _fetch = window.fetch;
      if (typeof _fetch === 'function' && !_fetch.__shgPatched) {
        window.fetch = function(input, init){
          try{
            var forced = forceAmountInUrl(input);
            if (forced) {
              if (input instanceof Request) {
                input = new Request(forced, input);
              } else {
                input = forced;
              }
            }
          }catch(_){}
          return _fetch.call(this, input, init);
        };
        window.fetch.__shgPatched = true;
      }
    } catch(_){}
  })();

  // XHR patch
  (function patchXHR(){
    try {
      var _open = XMLHttpRequest.prototype.open;
      var _send = XMLHttpRequest.prototype.send;

      if (!_open.__shgPatched) {
        XMLHttpRequest.prototype.open = function(method, url, async, user, password){
          try{ this.__shgForcedUrl = forceAmountInUrl(url) || null; }catch(_){}
          this._lastMethod = method;
          return _open.apply(this, arguments);
        };
        _open.__shgPatched = true;
      }

      if (!_send.__shgPatched) {
        XMLHttpRequest.prototype.send = function(body){
          try{
            if (this.__shgForcedUrl) {
              _open.call(this, this._lastMethod || 'GET', this.__shgForcedUrl, true);
            }
          }catch(_){}
          return _send.apply(this, arguments);
        };
        _send.__shgPatched = true;
      }
    } catch(_){}
  })();

  // ---------- (C) kick + keep things fresh around modal lifecycle ----------
  function kick(){
    resyncDom();
  }

  // Initial + a short burst to catch late mounts
  kick();
  var end = Date.now() + 6000;
  (function loop(){
    kick();
    if (Date.now() < end) requestAnimationFrame(loop);
  })();

  // When focus returns / tab visible (often right after modal closes)
  document.addEventListener('visibilitychange', function(){ if (!document.hidden) kick(); }, { passive: true });
  window.addEventListener('focus', kick, { passive: true });

  // Variant selectors often fire "change"
  document.addEventListener('change', function(e){
    if ((e.target && /variant|size|color|option/i.test(String(e.target.name||''))) || e.isTrusted) kick();
  }, { passive: true });

  window.__shgKlarnaLite = true;
})();
</script>

  {% endif %}

  {%- comment -%}
    =====================================================
    DRAFT PREVIEW SIDEBAR
    Only rendered when optimization is in draft status
    =====================================================
  {%- endcomment -%}

  {% if optimization_config and optimization_config.status == "draft" %}
    <template id="shogun-price-test-preview">
      {%- comment -%}
        =====================================================
        PREVIEW SIDEBAR STYLES
        =====================================================
      {%- endcomment -%}
      <style>
        /* ===== Layout ===== */
        .shg-preview__sidebar {
          position: fixed;
          top: 0;
          left: 0;
          width: 360px;
          height: 100%;
          overflow-y: auto;
          background: #fff;
          border-right: 1px solid #e5e7eb;
          font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
          z-index: 9999;
          box-sizing: border-box;
          padding-bottom: 70px; /* Add padding to account for the bottom preview bar */
        }

        /* ===== Header ===== */
        .shg-preview__header {
          margin-bottom: 12px;
          background: #F2F8FF;
          padding: 12px;
        }
        .shg-preview__header h3 {
          margin: 0 0 8px;
          font-size: 15px;
          font-weight: 600;
          color: #303030;
        }
        .shg-preview__header p {
          margin: 0 0 4px;
          font-size: 13px;
          color: #303030;
          line-height: 20px;
        }

        /* ===== Content Area ===== */
        .shg-preview__content {
          padding: 0 12px;
        }
        .shg-preview__currency {
          margin-top: 12px;
          font-size: 11px;
          color: #616161;
          font-weight: 500;
        }

        /* ===== Support Banner ===== */
        .shg-preview__support-banner {
          display: flex;
          flex-direction: column;
          align-items: flex-start;
          gap: 4px;
          padding: 12px 14px;
          border: 1px solid #e5e7eb;
          border-radius: 10px;
          margin-bottom: 20px;
          background: #fff;
          box-shadow:
            1px 0 0 0 rgba(0, 0, 0, 0.13) inset,
            -1px 0 0 0 rgba(0, 0, 0, 0.13) inset,
            0 -1px 0 0 rgba(0, 0, 0, 0.17) inset,
            0 1px 0 0 rgba(204, 204, 204, 0.50) inset,
            0 1px 0 0 rgba(26, 26, 26, 0.07);
        }
        .shg-preview__support-content {
          display: flex;
          align-items: center;
          gap: 12px;
        }
        .shg-preview__support-text {
          font-size: 13px;
          color: #374151;
          margin: 0 0 8px;
        }
        .shg-preview__support-btn {
          display: inline-block;
          padding: 6px 12px;
          font-size: 12px;
          font-weight: 550;
          color: #1a1a1a;
          background: #fff;
          border: 1px solid #d1d5db;
          border-radius: 6px;
          cursor: pointer;
          text-decoration: none;
          margin-left: 40px;
        }
        .shg-preview__support-btn:hover {
          background: #f9fafb;
        }

        /* ===== Product Card ===== */
        .shg-preview__product {
          overflow: hidden;
          display: flex;
          flex-direction: column;
          gap: 4px;
          margin-bottom: 12px;
        }
        .shg-preview__product-header {
          display: flex;
          align-items: center;
          gap: 10px;
        }
        .shg-preview__product-image {
          width: 36px;
          height: 36px;
          border-radius: 6px;
          border: 1px solid #e5e7eb;
          object-fit: cover;
          flex-shrink: 0;
        }
        .shg-preview__product-title {
          font-size: 13px;
          font-weight: 550;
          color: #303030;
        }
        .shg-preview__product-content {
          padding: 8px;
          border: 1px solid #e5e7eb;
          border-radius: 8px;
        }
        .shg-preview__product-link {
          display: flex;
          align-items: center;
          justify-content: center;
          flex-shrink: 0;
          color: #6b7280;
          text-decoration: none;
        }
        .shg-preview__product-link:hover {
          color: #374151;
        }
        .shg-preview__product-caret {
          margin-left: auto;
          background: none;
          border: none;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          flex-shrink: 0;
          width: 20px;
          height: 20px;
          padding: 0;
          transition: transform 0.2s ease;
          transform: rotate(180deg); /* Point down when expanded */
        }
        .shg-preview__product-caret.collapsed {
          transform: rotate(270deg); /* Point left when collapsed */
        }
        .shg-preview__product-content.collapsed {
          display: none;
        }
        .shg-preview__product-eye {
          width: 18px;
          height: 18px;
        }
        .shg-preview__product-variant-title {
          font-size: 12px;
          font-weight: 450;
          color: #616161;
        }

        /* ===== Variant Group (Two-Column Layout) ===== */
        .shg-preview__variant-group {
          display: grid;
          grid-template-columns: 22px 1fr;
          gap: 10px;
          margin-bottom: 12px;
        }
        .shg-preview__variant-group:last-child {
          margin-bottom: 0;
        }
        .shg-preview__variant-header {
          display: contents;
        }
        .shg-preview__variant-badge {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          width: 22px;
          height: 22px;
          font-size: 11px;
          font-weight: 600;
          color: #fff;
          background: #303030;
          border-radius: 50%;
        }
        .shg-preview__variant-name {
          font-size: 13px;
          font-weight: 500;
          color: #1a1a1a;
        }
        .shg-preview__variant-content {
          display: flex;
          flex-direction: column;
          gap: 4px;
        }

        /* ===== Variant Images ===== */
        .shg-preview__variant-images {
          display: flex;
          flex-wrap: wrap;
          gap: 6px;
        }
        .shg-preview__variant-images img {
          width: 44px;
          height: 44px;
          border-radius: 6px;
          border: 1px solid #e5e7eb;
          object-fit: cover;
        }
        .shg-preview__variant-image-placeholder {
          width: 44px;
          height: 44px;
          border-radius: 6px;
          border: 1px solid #e5e7eb;
          background: #e5e7eb;
          flex-shrink: 0;
        }

        /* ===== Variant Options ===== */
        .shg-preview__variant-options {
          padding-top: 4px;
          display: flex;
          flex-direction: column;
          gap: 4px;
        }
        .shg-preview__variant-option {
          display: flex;
          align-items: center;
          gap: 8px;
        }
        .shg-preview__variant-arrow {
          width: 12px;
          height: 12px;
          color: #9ca3af;
          flex-shrink: 0;
        }
        .shg-preview__variant-option-image {
          width: 32px;
          height: 32px;
          border-radius: 4px;
          border: 1px solid #e5e7eb;
          object-fit: cover;
          flex-shrink: 0;
        }
        .shg-preview__variant-option-image-placeholder {
          width: 32px;
          height: 32px;
          border-radius: 4px;
          border: 1px solid #e5e7eb;
          background: #e5e7eb;
          flex-shrink: 0;
        }
        .shg-preview__variant-option-text {
          font-size: 12px;
          color: #4a4a4a;
        }
        .shg-preview__variant-option-price {
          font-size: 12px;
          color: #1a1a1a;
        }

        /* ===== Price Display ===== */
        .shg-preview__compare-at-price {
          text-decoration: line-through;
          color: #1a1a1a;
          margin-left: 4px;
        }

        /* ===== Utility Classes ===== */
        .shg-preview__text-gray {
          color: #B5B5B5 !important;
        }
      </style>

      {%- comment -%}
        =====================================================
        PREVIEW SIDEBAR HTML
        =====================================================
      {%- endcomment -%}
      <div class="shg-preview__sidebar">
        {%- comment -%} Header Section {%- endcomment -%}
        <div class="shg-preview__header">
          {% if shg_is_product_details %}
            <div id="product_details_testing">
              <h3>Review your product detail updates</h3>
              <p>We've created a variant theme with your new product details. Check any place product details appear (product pages, collection pages, featured sections).</p>
            </div>
          {% else %}
            <div id="product_pricing_testing">
              <h3>Review your price updates</h3>
              <p>We've created a variant theme with your new pricing. Check any place prices appear (product pages, collection pages, featured sections).</p>
            </div>
          {% endif %}
          <p>When finished, close this tab to return to Shogun.</p>
          <div class="shg-preview__currency">
            Prices shown in {{ cart.currency.iso_code }}
          </div>
        </div>

        {%- comment -%} Content Section {%- endcomment -%}
        <div class="shg-preview__content">
          {%- comment -%} Support Banner {%- endcomment -%}
          <div class="shg-preview__support-banner">
            <div class="shg-preview__support-content">
              {{ info_icon_symbol }}
              <p class="shg-preview__support-text">If something is wrong, please let us know.</p>
            </div>
            <button class="shg-preview__support-btn" onclick="contactSupport()">Contact support</button>
          </div>

          {%- comment -%}
            =====================================================
            PRODUCT LIST - Iterates through optimization products

            For each product:
            1. Loads product data and A/B pricing metafields
            2. Loops through variants A and B, rendering each with:
               - Conditional styling (A = gray/dimmed, B = normal/blue)
               - Single variant view OR multiple variant list
            =====================================================
          {%- endcomment -%}
          {%- comment -%} Resolve this optimization's original (control) variant id for correct A/B lookups {%- endcomment -%}
          {% assign shg_original_variant = optimization_config.variants | where: 'original', true | first %}
          {% assign shg_original_variant_id = shg_original_variant.id %}

          {% for product_config in optimization_config.products %}
            {% assign shg_preview_product = all_products[product_config.handle] %}
            {% assign product_pricing_metafield = shg_preview_product.metafields[shogun_app_namespace]['product-pricing'] %}

            {% if shg_preview_product and shg_preview_product.variants.size > 0 and product_pricing_metafield.value %}
              {%- comment -%} Variant A = entry for this optimization's original (control); Variant B = entry for current preview (test) {%- endcomment -%}
              {% assign variant_a_data = product_pricing_metafield.value | find: 'shogun_variant_id', shg_original_variant_id %}
              {% assign variant_b_data = product_pricing_metafield.value | find: 'shogun_variant_id', shogun_variant_id %}

              <div class="shg-preview__product">
                <div class="shg-preview__product-header">
                  <img class="shg-preview__product-image" src="{{ shg_preview_product.featured_image | image_url: width: 64 }}" alt="{{ shg_preview_product.title }}" />
                  <span class="shg-preview__product-title">{{ shg_preview_product.title }}</span>
                  <a href="{{ shg_preview_product.url }}?shgpvid={{ shogun_variant_id }}" class="shg-preview__product-link" title="View product page">
                    {{ eye_symbol }}
                  </a>
                  <button class="shg-preview__product-caret" onclick="toggleProduct('shg-preview-{{ optimization_config.id }}-product-{{ shg_preview_product.handle }}')">
                    {{ caret_symbol }}
                  </button>
                </div>

                <div class="shg-preview__product-content" id="shg-preview-{{ optimization_config.id }}-product-{{ shg_preview_product.handle }}">

                  {%- comment -%} Calculate currency conversion ratio once per product using first variant {%- endcomment -%}
                  {%- assign shg_first_variant = shg_preview_product.variants.first -%}
                  {%- assign shg_first_variant_pricing = shg_first_variant.metafields[shogun_app_namespace]['product-variant-pricing'] -%}
                  {%- assign shg_first_original_pricing = shg_first_variant_pricing.value | find: 'original', true -%}
                  {%- assign shg_presentment_price = shg_first_variant.price -%}
                  {%- assign shg_shop_currency_price_cents = shg_first_original_pricing.price | times: 100 -%}
                  {%- if shg_presentment_price != shg_shop_currency_price_cents and shg_shop_currency_price_cents != 0 -%}
                    {%- assign shg_currency_ratio = shg_presentment_price | divided_by: shg_shop_currency_price_cents -%}
                  {%- else -%}
                    {%- assign shg_currency_ratio = 1 -%}
                  {%- endif -%}

                  {% if shg_preview_product.variants.size == 1 %}
                    {%- comment -%}
                     ==================================
                     ===== SINGLE VARIANT PRODUCT =====
                     Variant A = optimization original; Variant B = current preview (shogun_variant_id)
                     ==================================
                    {%- endcomment -%}

                    {% if variant_a_data %}
                    {%- comment -%} Variant A (Original) - from variant_a_data (optimization's original) {%- endcomment -%}
                    {%- assign shg_converted_price = variant_a_data.price | times: shg_currency_ratio | round: 2 | times: 100 -%}
                    {%- assign shg_converted_compare_at = variant_a_data.compare_at_price | times: shg_currency_ratio | round: 2 | times: 100 -%}
                    <div class="shg-preview__variant-group">
                      <div class="shg-preview__variant-header">
                        <span class="shg-preview__variant-badge">A</span>
                      </div>
                      <div class="shg-preview__variant-content">
                        {% if shg_is_product_details %}
                          <span class="shg-preview__variant-name shg-preview__text-gray">
                            {{ variant_a_data.title | default: shg_preview_product.title }}
                          </span>
                        {% endif %}
                        <div class="shg-preview__variant-option">
                          <span class="shg-preview__variant-option-price shg-preview__text-gray">
                            {{ shg_converted_price | money }}
                            {% if variant_a_data.compare_at_price != blank and variant_a_data.compare_at_price != "" and variant_a_data.compare_at_price != "0" and variant_a_data.compare_at_price != "0.00" %}
                              <span class="shg-preview__compare-at-price shg-preview__text-gray">({{ shg_converted_compare_at | money }})</span>
                            {% endif %}
                          </span>
                        </div>
                        {% if shg_is_product_details %}
                          <div class="shg-preview__variant-images">
                            {% if variant_a_data.media and variant_a_data.media.size > 0 %}
                              {% for media_item in variant_a_data.media %}
                                <img src="{{ media_item.preview_url }}" alt="{{ media_item.alt | default: variant_a_data.title | default: shg_preview_product.title }}" />
                              {% endfor %}
                            {% else %}
                              <img src="{{ shg_preview_product.featured_image | image_url: width: 80 }}" alt="{{ shg_preview_product.title }}" />
                            {% endif %}
                          </div>
                        {% endif %}
                      </div>
                    </div>
                    {% endif %}

                    {%- comment -%} Variant B (Test) - from variant_b_data (match current shogun_variant_id) {%- endcomment -%}
                    {% if variant_b_data %}
                      {%- assign shg_converted_price = variant_b_data.price | times: shg_currency_ratio | round: 2 | times: 100 -%}
                      {%- assign shg_converted_compare_at = variant_b_data.compare_at_price | times: shg_currency_ratio | round: 2 | times: 100 -%}
                      <div class="shg-preview__variant-group">
                        <div class="shg-preview__variant-header">
                          <span class="shg-preview__variant-badge" style="background: #0094D5;">B</span>
                        </div>
                        <div class="shg-preview__variant-content">
                          {% if shg_is_product_details %}
                            <span class="shg-preview__variant-name">
                              {{ variant_b_data.title | default: shg_preview_product.title }}
                            </span>
                          {% endif %}
                          <div class="shg-preview__variant-option">
                            <span class="shg-preview__variant-option-price">
                              {{ shg_converted_price | money }}
                              {% if variant_b_data.compare_at_price != blank and variant_b_data.compare_at_price != "" and variant_b_data.compare_at_price != "0" and variant_b_data.compare_at_price != "0.00" %}
                                <span class="shg-preview__compare-at-price">({{ shg_converted_compare_at | money }})</span>
                              {% endif %}
                            </span>
                          </div>
                          {% if shg_is_product_details %}
                            <div class="shg-preview__variant-images">
                              {% if variant_b_data.media and variant_b_data.media.size > 0 %}
                                {% for media_item in variant_b_data.media %}
                                  <img src="{{ media_item.preview_url }}" alt="{{ media_item.alt | default: variant_b_data.title | default: shg_preview_product.title }}" />
                                {% endfor %}
                              {% else %}
                                <span class="shg-preview__variant-image-placeholder" aria-hidden="true"></span>
                              {% endif %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                    {% endif %}

                  {% else %}

                    {%- comment -%}
                     ====================================
                     ===== MULTIPLE VARIANT PRODUCT =====
                     ====================================
                    {%- endcomment -%}

                    {% if variant_a_data %}
                    {%- comment -%} Variant A (Original) - header from variant_a_data; each row from variant metafield by shg_original_variant_id {%- endcomment -%}
                    <div class="shg-preview__variant-group">
                      <div class="shg-preview__variant-header">
                        <span class="shg-preview__variant-badge">A</span>
                      </div>
                      <div class="shg-preview__variant-content">
                        {% if shg_is_product_details %}
                          <span class="shg-preview__variant-name shg-preview__text-gray">
                            {{ variant_a_data.title | default: shg_preview_product.title }}
                          </span>
                          <div class="shg-preview__variant-images">
                            {% if variant_a_data.media and variant_a_data.media.size > 0 %}
                              {% for media_item in variant_a_data.media %}
                                <img src="{{ media_item.preview_url }}" alt="{{ media_item.alt | default: variant_a_data.title | default: shg_preview_product.title }}" />
                              {% endfor %}
                            {% else %}
                              <img src="{{ shg_preview_product.featured_image | image_url: width: 80 }}" alt="{{ shg_preview_product.title }}" />
                            {% endif %}
                          </div>
                        {% endif %}
                        <div class="shg-preview__product-variant-title shg-preview__text-gray">Product variants:</div>
                        <div class="shg-preview__variant-options">
                          {% for variant in shg_preview_product.variants %}
                            {% assign variant_original = variant.metafields[shogun_app_namespace]['product-variant-pricing'].value | find: 'shogun_variant_id', shg_original_variant_id %}
                            {% if variant_original %}
                              {%- assign shg_converted_price = variant_original.price | times: shg_currency_ratio | round: 2 | times: 100 -%}
                              {%- assign shg_converted_compare_at = variant_original.compare_at_price | times: shg_currency_ratio | round: 2 | times: 100 -%}
                              <div class="shg-preview__variant-option">
                                {{ variant_arrow_symbol }}
                                {% if shg_is_product_details %}
                                  {% if variant_original.media and variant_original.media.preview_url %}
                                    <img class="shg-preview__variant-option-image" src="{{ variant_original.media.preview_url }}" alt="{{ variant_original.media.alt | default: variant.title }}" />
                                  {% else %}
                                    {% assign variant_a_fallback_media = variant_a_data.media | first %}
                                    {% if variant_a_fallback_media and variant_a_fallback_media.preview_url %}
                                      <img class="shg-preview__variant-option-image" src="{{ variant_a_fallback_media.preview_url }}" alt="{{ variant_a_fallback_media.alt | default: variant.title }}" />
                                    {% else %}
                                      <span class="shg-preview__variant-option-image-placeholder" aria-hidden="true"></span>
                                    {% endif %}
                                  {% endif %}
                                {% endif %}
                                <span class="shg-preview__variant-option-text shg-preview__text-gray">{{ variant.title | default: "Default" }}:</span>
                                <span class="shg-preview__variant-option-price shg-preview__text-gray">
                                  {{ shg_converted_price | money }}
                                  {% if variant_original.compare_at_price != blank and variant_original.compare_at_price != "" and variant_original.compare_at_price != "0" and variant_original.compare_at_price != "0.00" %}
                                    <span class="shg-preview__compare-at-price shg-preview__text-gray">({{ shg_converted_compare_at | money }})</span>
                                  {% endif %}
                                </span>
                              </div>
                            {% endif %}
                          {% endfor %}
                        </div>
                      </div>
                    </div>
                    {% endif %}

                    {%- comment -%} Variant B (Test) - header from variant_b_data; each row from variant metafield by shogun_variant_id {%- endcomment -%}
                    {% if variant_b_data %}
                      <div class="shg-preview__variant-group">
                        <div class="shg-preview__variant-header">
                          <span class="shg-preview__variant-badge" style="background: #0094D5;">B</span>
                        </div>
                        <div class="shg-preview__variant-content">
                          {% if shg_is_product_details %}
                            <span class="shg-preview__variant-name">
                              {{ variant_b_data.title | default: shg_preview_product.title }}
                            </span>
                            <div class="shg-preview__variant-images">
                              {% if variant_b_data.media and variant_b_data.media.size > 0 %}
                                {% for media_item in variant_b_data.media %}
                                  <img src="{{ media_item.preview_url }}" alt="{{ media_item.alt | default: variant_b_data.title | default: shg_preview_product.title }}" />
                                {% endfor %}
                              {% else %}
                                <span class="shg-preview__variant-image-placeholder" aria-hidden="true"></span>
                              {% endif %}
                            </div>
                          {% endif %}
                          <div class="shg-preview__product-variant-title">Product variants:</div>
                          <div class="shg-preview__variant-options">
                            {% for variant in shg_preview_product.variants %}
                              {% assign variant_test = variant.metafields[shogun_app_namespace]['product-variant-pricing'].value | find: 'shogun_variant_id', shogun_variant_id %}
                              {% if variant_test %}
                                {%- assign shg_converted_price = variant_test.price | times: shg_currency_ratio | round: 2 | times: 100 -%}
                                {%- assign shg_converted_compare_at = variant_test.compare_at_price | times: shg_currency_ratio | round: 2 | times: 100 -%}
                                <div class="shg-preview__variant-option">
                                  {{ variant_arrow_symbol }}
                                  {% if shg_is_product_details %}
                                    {% if variant_test.media and variant_test.media.preview_url %}
                                      <img class="shg-preview__variant-option-image" src="{{ variant_test.media.preview_url }}" alt="{{ variant_test.media.alt | default: variant.title }}" />
                                    {% else %}
                                      {% assign variant_b_fallback_media = variant_b_data.media | first %}
                                      {% if variant_b_fallback_media and variant_b_fallback_media.preview_url %}
                                        <img class="shg-preview__variant-option-image" src="{{ variant_b_fallback_media.preview_url }}" alt="{{ variant_b_fallback_media.alt | default: variant.title }}" />
                                      {% else %}
                                        <span class="shg-preview__variant-option-image-placeholder" aria-hidden="true"></span>
                                      {% endif %}
                                    {% endif %}
                                  {% endif %}
                                  <span class="shg-preview__variant-option-text">{{ variant.title | default: "Default" }}:</span>
                                  <span class="shg-preview__variant-option-price">
                                    {{ shg_converted_price | money }}
                                    {% if variant_test.compare_at_price != blank and variant_test.compare_at_price != "" and variant_test.compare_at_price != "0" and variant_test.compare_at_price != "0.00" %}
                                      <span class="shg-preview__compare-at-price">({{ shg_converted_compare_at | money }})</span>
                                    {% endif %}
                                  </span>
                                </div>
                              {% endif %}
                            {% endfor %}
                          </div>
                        </div>
                      </div>
                    {% endif %}
                  {% endif %}
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>
    </template>

    <script>

      const COLLAPSED_STATE_KEY = 'shogun_price_test_sidebar_collapsed_state';

      function saveCollapsedState(elementId, isCollapsed) {
        try {
          const state = JSON.parse(localStorage.getItem(COLLAPSED_STATE_KEY) || '{}');
          state[elementId] = isCollapsed;
          localStorage.setItem(COLLAPSED_STATE_KEY, JSON.stringify(state));
        } catch (e) {
          console.warn('Failed to save collapsed state:', e);
        }
      }

      function restoreCollapsedState() {
        try {
          const state = JSON.parse(localStorage.getItem(COLLAPSED_STATE_KEY) || '{}');

          Object.keys(state).forEach(elementId => {
            const element = document.getElementById(elementId);
            if (element) {
              const caret = element.previousElementSibling?.querySelector('.shg-preview__product-caret');

              if (state[elementId]) {
                element.classList.add('collapsed');
                if (caret) {
                  caret.classList.add('collapsed');
                }
              } else {
                element.classList.remove('collapsed');
                if (caret) {
                  caret.classList.remove('collapsed');
                }
              }
            }
          });
        } catch (e) {
          console.warn('Failed to restore collapsed state:', e);
        }
      }

      function toggleElement(elementId) {
        const children = document.getElementById(elementId);
        if (!children) return;
        const caret = children.previousElementSibling?.querySelector('.shg-preview__product-caret');
        if (!caret) return;

        if (children.classList.contains('collapsed')) {
          // Expand: remove collapsed class first, then rotate caret
          children.classList.remove('collapsed');
          caret.classList.remove('collapsed');
          saveCollapsedState(elementId, false);
        } else {
          // Collapse: add collapsed class, then rotate caret
          children.classList.add('collapsed');
          caret.classList.add('collapsed');
          saveCollapsedState(elementId, true);
        }
      }

      function toggleProduct(productId) {
        toggleElement(productId);
      }

      function contactSupport() {
        const subject = encodeURIComponent('A/B Testing Question');
        const body = encodeURIComponent('Hi Shogun Team,\n\n');
        const mailtoLink = `mailto:support-ab@getshogun.com?subject=${subject}&body=${body}`;
        window.open(mailtoLink, '_blank');
      }

      window.restoreCollapsedState = restoreCollapsedState;
    </script>
  {% endif %}
{%- endif -%}

{%- comment -%}
  =====================================================
  OPTIMIZER INITIALIZATION
  =====================================================
{%- endcomment -%}
<script type="text/javascript">
  ;(function() {
    if (typeof ShogunOptimizer === 'undefined') {
      console.error("ShogunOptimizer is not defined. Please ensure the optimizer script is properly loaded.");
      return;
    }

    const designMode = {{ request.design_mode | default: false }};
    if (designMode) {
      console.debug("Design mode is enabled, skipping optimizer initialization");
      return;
    }

    // If the referrer url is the Shopify admin url or other known merchant domains, then set a local storage shg_is_merchant flag to true
    // This is used to remove the preview bar from the page for shoppers
    const referrer = document.referrer
    const merchantDomains = ['admin.shopify.com', 'ab.shgapi.com', 'abc.shogun.dev']
    if (!localStorage.getItem('_shg_is_merchant') && merchantDomains.some(domain => referrer.includes(domain))) {
      console.debug('Setting shg_is_merchant to true')
      localStorage.setItem('_shg_is_merchant', 'true')
    }

    // Check for optimization disable flags
    const urlParams = new URLSearchParams(window.location.search);
    const optimizationDisabled = urlParams.get('shg') === "false" || window.location.hostname.includes('shopifypreview');

    if (optimizationDisabled) {
      console.debug("Optimization is disabled, skipping optimizer initialization");
      return;
    }

    // Load shop metafield configuration
    {% if shop.metafields.shgabc.optimizations %}
    const shopMetafieldConfig = {{ shop.metafields.shgabc.optimizations }};
    {% else %}
    const shopMetafieldConfig = {};
    {% endif %}

    const optimizationsData = shopMetafieldConfig.expires_at > Date.now() ? (shopMetafieldConfig.optimizations || []) : [];

    // Build optimizer configuration
    const optimizerConfig = {
      shopId: "625a3ac7-fa57-4d35-94c6-be0547643cc0",
      optimizations: optimizationsData,
      distributionMethod: urlParams.get('shgMethod') || shopMetafieldConfig.method,
      defaultThemeId: shopMetafieldConfig.default_theme_id ? shopMetafieldConfig.default_theme_id.toString() : null,
      currentThemeId: "152023859419",
      pageId: "{{ content.id }}",
      pageType: "{% if template.name == 'list-collections' %}list-collections{% elsif article %}article{% elsif blog %}blog{% elsif page %}page{% elsif product %}product{% elsif collection %}collection{% elsif metaobject %}metaobject{% else %}homepage{% endif %}",
      templateName: "{{ template.name }}",
      templateSuffix: "{{ template.suffix }}",
      customerId: "{{ customer.id }}",
      isB2B: {{ customer.b2b? | default: false }},
      sessionIdOverride: urlParams.get('shgSessionId'),
      geoLocationApi: "https://ipinfo.io/json?token=f2ae3a557d807b",
      currentCartVariantId: {% if cart.attributes.shogun_variant_id %}"{{ cart.attributes.shogun_variant_id }}"{% else %}null{% endif %},
      languageRootUrl: "{{ localization.language.root_url }}",
      analyticsUrl: "https://shogun-abc-production.global.ssl.fastly.net",
      storefrontAccessToken: null,
      shopDomain: ""
    };

    console.debug("Initializing ShogunOptimizer with config:", optimizerConfig);
    const optimizer = new ShogunOptimizer(optimizerConfig);
    optimizer.run();
  })();
</script>

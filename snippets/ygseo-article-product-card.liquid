{% comment %}
  产品卡片组件
  接收参数:
  - product: 产品对象
{% endcomment %}

{% if product != blank %}
<style>
#ygseo-product-card {
    background-color: #f5f5f5;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

#ygseo-product-card .ygseo-product-card__content {
    display: flex;
    align-items: center;
}

#ygseo-product-card .ygseo-product-card__image-container {
    flex: 0 0 33.333%;
    margin-right: 20px;
    overflow: hidden;
    border-radius: 4px;
}

#ygseo-product-card .ygseo-product-card__image-link {
    display: block;
    text-decoration: none;
    overflow: hidden;
}

#ygseo-product-card .ygseo-product-card__image {
    width: 100%;
    height: auto;
    object-fit: contain;
    border-radius: 4px;
    transition: transform 0.3s ease;
}

#ygseo-product-card .ygseo-product-card__image:hover {
    transform: scale(1.05);
}

#ygseo-product-card .ygseo-product-card__info {
    flex: 1;
}

#ygseo-product-card .ygseo-product-card__title {
    font-size: 18px;
    font-weight: 600;
    margin: 0 0 10px;
}

#ygseo-product-card .ygseo-product-card__title a {
    color: #333;
    text-decoration: none;
}

#ygseo-product-card .ygseo-product-card__price {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 10px;
}

#ygseo-product-card .ygseo-product-card__description {
    font-size: 14px;
    color: #666;
    margin-bottom: 15px;
}

#ygseo-product-card .ygseo-product-card__actions {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 15px;
}

#ygseo-product-card .ygseo-product-card__learn-more {
    flex: 1;
    display: inline-block;
    padding: 10px 15px;
    background: #fff;
    color: #333;
    border: 1px solid #ddd;
    border-radius: 4px;
    text-decoration: none;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease;
    text-align: center;
}

#ygseo-product-card .ygseo-product-card__learn-more:hover {
    background-color: #f0f0f0;
    border-color: #ccc;
}

#ygseo-product-card .ygseo-product-card__form {
    flex: 1;
    margin: 0 !important;
}

#ygseo-product-card .ygseo-product-card__add-to-cart {
    width: 100%;
    display: inline-block;
    padding: 10px 15px;
    background-color: #000;
    color: #fff;
    border: none;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
    margin: 0 !important;
}

#ygseo-product-card .ygseo-product-card__add-to-cart:hover {
    background-color: #333;
}

@media screen and (max-width: 767px) {
    #ygseo-product-card .ygseo-product-card__content {
    flex-direction: column;
    }
    
    #ygseo-product-card .ygseo-product-card__image-container {
    margin-right: 0;
    margin-bottom: 15px;
    width: 100%;
    }
    
    #ygseo-product-card .ygseo-product-card__actions {
    flex-direction: column;
    gap: 10px;
    }
    
    #ygseo-product-card .ygseo-product-card__learn-more,
    #ygseo-product-card .ygseo-product-card__add-to-cart {
    width: 100%;
    text-align: center;
    }
}
</style>

<div id="ygseo-product-card">
    <div class="ygseo-product-card__content">
        <div class="ygseo-product-card__image-container">
        <a href="{{ product.url }}" class="ygseo-product-card__image-link">
            {% if product.featured_media %}
            <img 
                src="{{ product.featured_media | img_url: '300x300', crop: 'center' }}" 
                alt="{{ product.featured_media.alt | escape }}"
                class="ygseo-product-card__image"
                loading="lazy"
                width="150"
                height="150"
            >
            {% else %}
            {{ 'product-1' | placeholder_svg_tag: 'ygseo-product-card__image placeholder' }}
            {% endif %}
        </a>
        </div>
        <div class="ygseo-product-card__info">
        <h3 class="ygseo-product-card__title">
            <a href="{{ product.url }}">{{ product.title }}</a>
        </h3>
        
        <div class="ygseo-product-card__price">
            <span class="ygseo-product-card__price-amount">Price : {{ product.price | money }}</span>
        </div>
                
        <div class="ygseo-product-card__description">
            {{ product.description | strip_html | truncatewords: 10 }}
        </div>
        
        <div class="ygseo-product-card__actions">
            <a href="{{ product.url }}" class="ygseo-product-card__learn-more">Learn more</a>
            
            <div class="ygseo-product-card__form">
                <input type="hidden" class="product-variant-id" value="{{ product.selected_or_first_available_variant.id }}">
                <button type="button" 
                        class="ygseo-product-card__add-to-cart" 
                        data-add-to-cart
                        onclick="addToCartDrawer(this)">
                    Add to Cart
                </button>
            </div>
        </div>
        </div>
    </div>
</div>

<script>
function addToCartDrawer(button) {
    const variantId = parseInt(button.parentNode.querySelector('.product-variant-id').value);
    const originalText = button.innerHTML;
    const cartDrawer = document.querySelector('cart-drawer');
    
    button.innerHTML = 'Adding...';
    button.disabled = true;

    fetch(`${Shopify.routes.root}cart/add.js`, {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            items:[{
                id: variantId,
                quantity: 1
            }]
        })
    })
    .then(async response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        
        // 触发主题的购物车刷新
        document.dispatchEvent(new CustomEvent("cart:refresh"));
        document.dispatchEvent(new CustomEvent('dispatch:cart-drawer:refresh'));
        
        // 手动打开购物车抽屉
        if (cartDrawer) {
            cartDrawer.setAttribute('open', '');
            cartDrawer.classList.add('active');
            cartDrawer.style.opacity = '1';
            cartDrawer.style.display = 'block';
            cartDrawer.style.visibility = 'visible';
            document.querySelector('.js-overlay')?.classList.add('is-visible');
        } else if (document.getElementById('t4s-mini_cart') && document.querySelector('.t4s-close-overlay')) {
            // T4S主题购物车处理
            const miniCart = document.getElementById('t4s-mini_cart');
            const overlay = document.querySelector('.t4s-close-overlay');
            miniCart.setAttribute('aria-hidden', 'false');
            overlay.classList.add('is--visible');
        } else {
            // 兜底方案：给body添加类名
            document.body.classList.add('cart-sidebar-show');
        }
            
        // 触发抽屉打开事件
        document.documentElement.dispatchEvent(new CustomEvent('cart:open', {
            bubbles: true
        }));
        
    })
    .catch(error => {
        console.error('[YGSEO Product Card] Add to cart error:', error);
        document.documentElement.dispatchEvent(new CustomEvent('cart:error', {
            detail: { 
                message: 'Adding cart failed, please try again later.',
                error: error.message
            }
        }));
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}
document.addEventListener('click', function (e) {
  // 检查点击事件是否在购物车按钮内，使用类名匹配关闭按钮
  const isInDrawerButton = e.target.closest('.t4s-drawer__header .t4s-drawer__close');

  if (isInDrawerButton) {
    // 修改这里：使用与打开购物车相对应的关闭方法
    const cartDrawer = document.querySelector('cart-drawer');
    if (cartDrawer) {
      cartDrawer.removeAttribute('open');
      cartDrawer.classList.remove('active');
      cartDrawer.style.opacity = '0';
      cartDrawer.style.visibility = 'hidden';
    } else if (document.getElementById('t4s-mini_cart') && document.querySelector('.t4s-close-overlay')) {
      // T4S主题购物车处理
      const miniCart = document.getElementById('t4s-mini_cart');
      const overlay = document.querySelector('.t4s-close-overlay');
      miniCart.setAttribute('aria-hidden', 'true');
      overlay.classList.remove('is--visible');
    } else {
      // 兜底方案：移除body类名
      document.body.classList.remove('cart-sidebar-show');
    }
    
    // 保留原有事件触发，以兼容可能存在的其他处理程序
    document.dispatchEvent(new CustomEvent('dispatch:cart-drawer:close'));
    // 添加标准的cart:close事件
    document.documentElement.dispatchEvent(new CustomEvent('cart:close', {
      bubbles: true
    }));
  }
});
</script>
{% endif %}